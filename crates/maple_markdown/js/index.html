<!DOCTYPE html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.5.1/github-markdown.min.css" >
    <!-- GitHub Alerts styling from markdown-it-github-alerts
         Source: https://github.com/antfu/markdown-it-github-alerts
         These styles are extracted from GitHub's official alert implementation -->
    <link rel="stylesheet" href="https://unpkg.com/markdown-it-github-alerts@0.3.0/styles/github-base.css">
    <link rel="stylesheet" href="https://unpkg.com/markdown-it-github-alerts@0.3.0/styles/github-colors-light.css">
    <link rel="stylesheet" href="https://unpkg.com/markdown-it-github-alerts@0.3.0/styles/github-colors-dark-media.css">
    <!-- Code highlight -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <!-- and it's easy to individually load additional languages -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/go.min.js"></script>

    <!-- KaTeX CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">

    <!-- KaTeX Auto-render extension + KaTeX main -->
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js"></script>

    <!-- Mermaid -->
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: false });
        window.mermaid = mermaid;
    </script>

    <style>
      body {
        margin: 0;
        padding: 0;
        display: flex;
        height: 100vh;
        overflow: hidden;
      }

      #sidebar {
        width: 250px;
        background: #f6f8fa;
        border-right: 1px solid #d0d7de;
        padding: 20px;
        box-sizing: border-box;
        overflow-y: auto;
        flex-shrink: 0;
        order: 1;
      }

      #sidebar h3 {
        margin: 0 0 15px 0;
        font-size: 14px;
        font-weight: 600;
        color: #24292f;
      }

      .sidebar-section {
        margin-bottom: 20px;
      }

      .recent-files {
        max-height: 200px;
        overflow-y: auto;
      }

      .recent-file-item {
        padding: 6px 8px;
        margin: 4px 0;
        background: #ffffff;
        border: 1px solid #d0d7de;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      .recent-file-item:hover {
        background: #f0f6fc;
        border-color: #0969da;
      }

      .recent-file-item.current {
        background: #e6f2ff;
        border-color: #0969da;
      }

      .recent-file-name {
        font-size: 13px;
        font-weight: 600;
        color: #24292f;
      }

      .recent-file-item:hover .recent-file-name {
        color: #0969da;
      }

      .recent-file-item.current .recent-file-name {
        color: #0969da;
      }

      .recent-file-path {
        font-size: 11px;
        color: #8b949e;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .recent-file-item:hover .recent-file-path {
        color: #6e7781;
      }

      .no-recent-files {
        padding: 8px;
        font-size: 12px;
        color: #8b949e;
        font-style: italic;
      }

      .option-group {
        padding: 8px 0;
      }

      .option-label {
        display: block;
        font-size: 13px;
        color: #57606a;
        margin-bottom: 6px;
        font-weight: 500;
      }

      .option-select {
        width: 100%;
        padding: 6px 8px;
        font-size: 13px;
        border: 1px solid #d0d7de;
        border-radius: 6px;
        background-color: #ffffff;
        color: #24292f;
        cursor: pointer;
        transition: border-color 0.2s;
      }

      .option-select:hover {
        border-color: #8c959f;
      }

      .option-select:focus {
        outline: none;
        border-color: #0969da;
        box-shadow: 0 0 0 3px rgba(9, 105, 218, 0.1);
      }

      #toc-panel {
        width: 250px; /* Default, will be adjusted based on screen size */
        min-width: 150px;
        max-width: 500px;
        background: #f6f8fa;
        padding: 20px;
        box-sizing: border-box;
        overflow-y: auto;
        flex-shrink: 0;
        display: none;
        position: relative;
        order: 2; /* Default position between sidebar and content */
      }

      #toc-panel.visible {
        display: block;
      }

      /* Left-side TOC (default) */
      #toc-panel.toc-left {
        border-right: 1px solid #d0d7de;
        border-left: none;
        order: 2;
      }

      #toc-panel.toc-left .toc-resize-handle {
        right: 0;
        left: auto;
      }

      /* Right-side TOC */
      #toc-panel.toc-right {
        border-left: 1px solid #d0d7de;
        border-right: none;
        order: 4;
      }

      #toc-panel.toc-right .toc-resize-handle {
        left: 0;
        right: auto;
      }

      .toc-resize-handle {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 5px;
        cursor: col-resize;
        background: transparent;
        transition: background 0.2s;
      }

      .toc-resize-handle:hover {
        background: #0969da;
      }

      .toc-resize-handle.resizing {
        background: #0969da;
      }

      .toc-header {
        font-size: 14px;
        font-weight: 600;
        color: #24292f;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid #d0d7de;
      }

      .toc-content {
        font-size: 14px;
      }

      .toc-content a {
        display: block;
        color: #57606a;
        text-decoration: none;
        padding: 6px 8px;
        margin: 2px 0;
        border-radius: 6px;
        transition: all 0.2s;
        border-left: 3px solid transparent;
      }

      .toc-content a:hover {
        color: #0969da;
        background: #f0f6fc;
        border-left-color: #0969da;
      }

      .toc-content .toc-h1 {
        font-weight: 700;
        font-size: 15px;
        margin-top: 12px;
        padding: 8px 10px;
        color: #24292f;
        background: #eff2f5;
        border-left: 4px solid #0969da;
      }

      .toc-content .toc-h1:hover {
        background: #e6ebf1;
      }

      .toc-content .toc-h2 {
        padding-left: 20px;
        font-weight: 600;
        font-size: 14px;
        color: #1f2328;
      }

      .toc-content .toc-h3 {
        padding-left: 32px;
        font-size: 13px;
        font-weight: 500;
      }

      .toc-content .toc-h4 {
        padding-left: 44px;
        font-size: 13px;
        font-weight: 400;
        opacity: 0.9;
      }

      .toc-content .toc-h5,
      .toc-content .toc-h6 {
        padding-left: 56px;
        font-size: 12px;
        opacity: 0.8;
      }

      #main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        order: 3;
        overflow-y: auto;
      }

      #main-content > .markdown-body {
        flex: 0 1 auto;
        align-self: center;
      }

      .markdown-body {
        box-sizing: border-box;
        min-width: 200px;
        max-width: 980px;
        width: 100%;
        padding: 45px;
        position: relative;
      }

      /* Font family options */
      .markdown-body.font-serif {
        font-family: "Palatino Linotype", Palatino, Palladio, "URW Palladio L", "Book Antiqua", Baskerville, "Bookman Old Style", "Bitstream Charter", "Nimbus Roman No9 L", Garamond, "Apple Garamond", "ITC Garamond Narrow", "New Century Schoolbook", "Century Schoolbook", "Century Schoolbook L", Georgia, serif;
      }

      .markdown-body.font-serif h1,
      .markdown-body.font-serif h2,
      .markdown-body.font-serif h3,
      .markdown-body.font-serif h4,
      .markdown-body.font-serif h5,
      .markdown-body.font-serif h6 {
        font-family: "Palatino Linotype", Palatino, Georgia, serif;
      }

      .markdown-body.font-mono {
        font-family: ui-monospace, SFMono-Regular, "SF Mono", Menlo, Consolas, "Liberation Mono", monospace;
        font-size: 13px;
        line-height: 1.6;
      }

      .markdown-body.font-system {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans", Helvetica, Arial, sans-serif;
      }

      /* Reader Mode - optimized for focused reading */
      .markdown-body.reader-mode {
        max-width: 750px;
        font-size: 18px;
        line-height: 1.7;
      }

      .markdown-body.reader-mode p {
        margin-top: 1.2em;
        margin-bottom: 1.2em;
      }

      .markdown-body.reader-mode h1 {
        margin-top: 1.5em;
        margin-bottom: 0.8em;
      }

      .markdown-body.reader-mode h2 {
        margin-top: 1.3em;
        margin-bottom: 0.7em;
      }

      .markdown-body.reader-mode h3,
      .markdown-body.reader-mode h4,
      .markdown-body.reader-mode h5,
      .markdown-body.reader-mode h6 {
        margin-top: 1.2em;
        margin-bottom: 0.6em;
      }

      .markdown-body.reader-mode ul,
      .markdown-body.reader-mode ol {
        margin-top: 1em;
        margin-bottom: 1em;
      }

      .markdown-body.reader-mode li {
        margin-top: 0.4em;
        margin-bottom: 0.4em;
      }

      .markdown-body.reader-mode blockquote {
        margin-top: 1.2em;
        margin-bottom: 1.2em;
      }

      .markdown-body.reader-mode pre {
        margin-top: 1.2em;
        margin-bottom: 1.2em;
      }

      /* Markdown content line numbers */
      .markdown-body.show-line-numbers {
        padding-left: 90px;
      }

      .markdown-body.show-line-numbers > * {
        position: relative;
      }

      /* Single line number (rendered or source) */
      .markdown-body.show-line-numbers > *::before {
        content: attr(data-line-number);
        position: absolute;
        left: -60px;
        width: 40px;
        text-align: right;
        color: #999;
        font-size: 12px;
        user-select: none;
        padding-right: 10px;
        font-family: monospace;
      }

      /* Both line numbers mode */
      .markdown-body.show-line-numbers-both {
        padding-left: 110px;
      }

      .markdown-body.show-line-numbers-both > * {
        position: relative;
      }

      .markdown-body.show-line-numbers-both > *::before {
        content: attr(data-rendered-number) " / " attr(data-source-number);
        position: absolute;
        left: -90px;
        width: 70px;
        text-align: right;
        color: #999;
        font-size: 11px;
        user-select: none;
        padding-right: 10px;
        font-family: monospace;
      }

      @media (prefers-color-scheme: dark) {
        body {
          background: #0d1117;
        }

        #sidebar {
          background: #161b22;
          border-right-color: #30363d;
        }

        #sidebar h3 {
          color: #c9d1d9;
        }

        .option-label {
          color: #8b949e;
        }

        .option-select {
          background-color: #0d1117;
          border-color: #30363d;
          color: #c9d1d9;
        }

        .option-select:hover {
          border-color: #6e7681;
        }

        .option-select:focus {
          border-color: #58a6ff;
          box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.1);
        }

        .recent-file-item {
          background: #0d1117;
          border-color: #30363d;
        }

        .recent-file-item:hover {
          background: #1c2128;
          border-color: #58a6ff;
        }

        .recent-file-item.current {
          background: #1c2d41;
          border-color: #58a6ff;
        }

        .recent-file-name {
          color: #c9d1d9;
        }

        .recent-file-item:hover .recent-file-name,
        .recent-file-item.current .recent-file-name {
          color: #58a6ff;
        }

        .recent-file-path {
          color: #6e7781;
        }

        .recent-file-item:hover .recent-file-path {
          color: #8b949e;
        }

        .markdown-body.show-line-numbers > *::before,
        .markdown-body.show-line-numbers-both > *::before {
          color: #6e7681;
        }

        #toc-panel {
          background: #161b22;
        }

        #toc-panel.toc-left {
          border-right-color: #30363d;
        }

        #toc-panel.toc-right {
          border-left-color: #30363d;
        }

        .toc-header {
          color: #c9d1d9;
          border-bottom-color: #30363d;
        }

        .toc-content a {
          color: #8b949e;
        }

        .toc-content a:hover {
          color: #58a6ff;
          background: #1c2128;
          border-left-color: #58a6ff;
        }

        .toc-content .toc-h1 {
          color: #c9d1d9;
          background: #21262d;
          border-left-color: #58a6ff;
        }

        .toc-content .toc-h1:hover {
          background: #2d333b;
        }

        .toc-content .toc-h2 {
          color: #c9d1d9;
        }

        .toc-resize-handle:hover,
        .toc-resize-handle.resizing {
          background: #58a6ff;
        }
      }

      @media (max-width: 767px) {
        body {
          flex-direction: column;
        }

        #sidebar {
          width: 100%;
          border-right: none;
          border-bottom: 1px solid #d0d7de;
        }

        .markdown-body {
          padding: 15px;
        }
      }

      /* File path bar */
      .file-path-bar {
        background: #f6f8fa;
        border-bottom: 1px solid #d0d7de;
        padding: 8px 20px 18px 20px;
        font-family: ui-monospace, SFMono-Regular, "SF Mono", Menlo, Consolas, "Liberation Mono", monospace;
        font-size: 13px;
        line-height: 1;
        color: #57606a;
        cursor: pointer;
        user-select: none;
        transition: background 0.2s;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .file-path-bar:hover {
        background: #eef2f6;
      }

      .file-path-bar:active {
        background: #e6ebf1;
      }

      .git-root {
        color: #0969da;
        font-weight: 600;
        vertical-align: baseline;
      }

      .file-path-bar:hover .git-root {
        color: #0550ae;
      }

      .relative-path {
        color: #57606a;
        font-weight: 400;
      }

      .file-path-bar:hover .relative-path {
        color: #24292f;
      }

      .path-separator {
        color: #8b949e;
        margin: 0 2px;
      }

      @media (prefers-color-scheme: dark) {
        .file-path-bar {
          background: #161b22;
          border-bottom-color: #30363d;
          color: #8b949e;
        }

        .file-path-bar:hover {
          background: #1c2128;
        }

        .file-path-bar:active {
          background: #21262d;
        }

        .git-root {
          color: #58a6ff;
        }

        .file-path-bar:hover .git-root {
          color: #79c0ff;
        }

        .relative-path {
          color: #8b949e;
        }

        .file-path-bar:hover .relative-path {
          color: #c9d1d9;
        }

        .path-separator {
          color: #6e7681;
        }
      }

      /* Toast notification for clipboard */
      .toast {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%) translateY(-20px);
        background: #0969da;
        color: #ffffff;
        padding: 16px 32px;
        border-radius: 8px;
        box-shadow: 0 8px 24px rgba(9, 105, 218, 0.5);
        font-size: 16px;
        font-weight: 600;
        z-index: 10000;
        opacity: 0;
        transition: opacity 0.3s, transform 0.3s;
        pointer-events: none;
        min-width: 250px;
        max-width: 600px;
        text-align: center;
      }

      .toast-title {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 6px;
      }

      .toast-path {
        font-size: 12px;
        font-weight: 400;
        opacity: 0.9;
        word-break: break-all;
      }

      .toast.show {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }

      @media (prefers-color-scheme: dark) {
        .toast {
          background: #58a6ff;
          color: #0d1117;
          box-shadow: 0 8px 24px rgba(88, 166, 255, 0.5);
        }
      }
    </style>
    <title>Markdown Preview</title>
</head>
<body>
    <div id="sidebar">
        <div class="sidebar-section">
            <h3>Recent Previews</h3>
            <div id="recent-files" class="recent-files"></div>
        </div>
        <div class="sidebar-section">
            <h3>Display Options</h3>
            <div class="option-group">
                <label class="option-label">Line Numbers</label>
                <select id="line-numbers-mode" class="option-select">
                    <option value="off">Off</option>
                    <option value="rendered">Rendered Elements (1, 2, 3...)</option>
                    <option value="source">Source File (Git-style)</option>
                    <option value="both">Both (Rendered / Source)</option>
                </select>
            </div>
            <div class="option-group">
                <label class="option-label">Table of Contents</label>
                <select id="toc-mode" class="option-select">
                    <option value="off">Off</option>
                    <option value="left">Show (Left)</option>
                    <option value="right">Show (Right)</option>
                </select>
            </div>
            <div class="option-group">
                <label class="option-label">Font Family</label>
                <select id="font-family" class="option-select">
                    <option value="default">GitHub (Default)</option>
                    <option value="serif">Serif (LaTeX-like)</option>
                    <option value="mono">Monospace</option>
                    <option value="system">System UI</option>
                </select>
            </div>
            <div class="option-group">
                <label class="option-label">Reading Mode</label>
                <select id="reader-mode" class="option-select">
                    <option value="off">Normal</option>
                    <option value="on">Reader Mode</option>
                </select>
            </div>
        </div>
    </div>

    <div id="toc-panel" class="toc-panel">
        <div class="toc-header">Table of Contents</div>
        <nav id="toc-content" class="toc-content"></nav>
        <div class="toc-resize-handle"></div>
    </div>

    <div id="main-content">
        <div class="file-path-bar" id="file-path-bar" title="Click to copy path"></div>
        <article class="markdown-body" id="content"></article>
    </div>

    <script>
        let lineNumberMode = 'off';  // 'off', 'rendered', 'source', 'both'
        let currentSourceLines = 0;
        let currentLineMap = [];  // Array mapping element index to source line number
        let tocVisible = false;
        let fontFamily = 'default';  // 'default', 'serif', 'mono', 'system'
        let readerMode = false;  // Reader mode toggle
        let currentFilePath = '';  // Current file being previewed
        let websocket = null;  // WebSocket connection

        function codeHighlight() {
            if (hljs !== undefined) {
                document.querySelectorAll('pre code').forEach((el) => {
                  hljs.highlightElement(el);
                });
            }
        }

        async function renderMermaid() {
            if (window.mermaid !== undefined) {
                await window.mermaid.run({
                    querySelector: '.language-mermaid'
                });
            }
        }

        function applyLineNumberMode(mode, sourceLines, lineMap) {
            const content = document.getElementById('content');
            if (!content) return;

            // Update current source lines if provided
            if (sourceLines) {
                currentSourceLines = sourceLines;
            }

            // Update line map if provided
            if (lineMap) {
                currentLineMap = lineMap;
            }

            // Remove all line number classes and attributes
            content.classList.remove('show-line-numbers', 'show-line-numbers-both');
            const children = Array.from(content.children);
            children.forEach((child) => {
                child.removeAttribute('data-line-number');
                child.removeAttribute('data-source-line');
                child.removeAttribute('data-rendered-number');
                child.removeAttribute('data-source-number');
            });

            if (mode === 'off') {
                return;
            }

            if (mode === 'rendered') {
                // Show simple 1, 2, 3... numbering
                content.classList.add('show-line-numbers');
                children.forEach((child, index) => {
                    const renderedNum = index + 1;
                    child.setAttribute('data-line-number', renderedNum);
                    // Use line map for scrolling if available, otherwise use rendered number
                    const sourceNum = currentLineMap[index] || renderedNum;
                    child.setAttribute('data-source-line', sourceNum);
                });
            } else if (mode === 'source') {
                // Show actual source file line numbers from line map
                content.classList.add('show-line-numbers');
                children.forEach((child, index) => {
                    // Use line map if available, otherwise fall back to naive calculation
                    const sourceNum = currentLineMap[index] || Math.min(
                        Math.floor((index / Math.max(1, children.length)) * currentSourceLines) + 1,
                        currentSourceLines
                    );
                    child.setAttribute('data-line-number', sourceNum);
                    child.setAttribute('data-source-line', sourceNum);
                });
            } else if (mode === 'both') {
                // Show both rendered/source
                content.classList.add('show-line-numbers-both');
                children.forEach((child, index) => {
                    const renderedNum = index + 1;
                    // Use line map if available, otherwise fall back to naive calculation
                    const sourceNum = currentLineMap[index] || Math.min(
                        Math.floor((index / Math.max(1, children.length)) * currentSourceLines) + 1,
                        currentSourceLines
                    );
                    child.setAttribute('data-rendered-number', renderedNum);
                    child.setAttribute('data-source-number', sourceNum);
                    child.setAttribute('data-source-line', sourceNum);
                });
            }
        }

        function changeLineNumberMode(newMode) {
            lineNumberMode = newMode;
            applyLineNumberMode(lineNumberMode, currentSourceLines, currentLineMap);
            localStorage.setItem('lineNumberMode', lineNumberMode);
        }

        // Scroll to a specific source line
        function scrollToSourceLine(lineNumber) {
            const content = document.getElementById('content');
            if (!content) return;

            const children = Array.from(content.children);
            let closestElement = null;
            let closestDiff = Infinity;

            children.forEach((child) => {
                const sourceLine = parseInt(child.getAttribute('data-source-line') || '0');
                const diff = Math.abs(sourceLine - lineNumber);
                if (diff < closestDiff) {
                    closestDiff = diff;
                    closestElement = child;
                }
            });

            if (closestElement) {
                closestElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                // Highlight briefly
                closestElement.style.backgroundColor = '#ffeb3b';
                setTimeout(() => {
                    closestElement.style.backgroundColor = '';
                }, 1000);
            }
        }

        // Generate Table of Contents from headings
        function generateTOC() {
            const content = document.getElementById('content');
            const tocContent = document.getElementById('toc-content');
            if (!content || !tocContent) return;

            const headings = content.querySelectorAll('h1, h2, h3, h4, h5, h6');
            tocContent.innerHTML = '';

            headings.forEach((heading, index) => {
                const level = heading.tagName.toLowerCase();
                const text = heading.textContent;
                const id = heading.id || `heading-${index}`;

                if (!heading.id) {
                    heading.id = id;
                }

                const link = document.createElement('a');
                link.href = `#${id}`;
                link.textContent = text;
                link.className = `toc-${level}`;
                link.onclick = (e) => {
                    e.preventDefault();
                    heading.scrollIntoView({ behavior: 'smooth', block: 'start' });
                };

                tocContent.appendChild(link);
            });
        }

        // Get smart default TOC width based on screen size
        function getDefaultTOCWidth() {
            const screenWidth = window.innerWidth;
            // For wide monitors (>= 1920px), use 350px
            // For medium screens (>= 1440px), use 300px
            // For smaller screens, use 250px
            if (screenWidth >= 1920) {
                return 350;
            } else if (screenWidth >= 1440) {
                return 300;
            } else {
                return 250;
            }
        }

        // Toggle TOC visibility and position
        function toggleTOC(mode) {
            // mode can be 'off', 'left', or 'right'
            const tocPanel = document.getElementById('toc-panel');

            if (mode === 'off') {
                tocVisible = false;
                tocPanel.classList.remove('visible', 'toc-left', 'toc-right');
            } else {
                tocVisible = true;
                tocPanel.classList.add('visible');

                // Remove old position classes and add new one
                if (mode === 'left') {
                    tocPanel.classList.remove('toc-right');
                    tocPanel.classList.add('toc-left');
                } else if (mode === 'right') {
                    tocPanel.classList.remove('toc-left');
                    tocPanel.classList.add('toc-right');
                }

                generateTOC();

                // Restore saved width if available, otherwise use smart default
                const savedWidth = localStorage.getItem('tocWidth');
                if (savedWidth) {
                    tocPanel.style.width = savedWidth + 'px';
                } else {
                    const defaultWidth = getDefaultTOCWidth();
                    tocPanel.style.width = defaultWidth + 'px';
                }
            }

            localStorage.setItem('tocMode', mode);
        }

        // Change font family
        function changeFontFamily(family) {
            fontFamily = family;
            const content = document.getElementById('content');
            if (!content) return;

            // Remove all font classes
            content.classList.remove('font-serif', 'font-mono', 'font-system');

            // Add new font class if not default
            if (family !== 'default') {
                content.classList.add('font-' + family);
            }

            localStorage.setItem('fontFamily', family);
        }

        // Toggle Reader Mode
        function toggleReaderMode(enabled) {
            readerMode = enabled;
            const content = document.getElementById('content');
            if (!content) return;

            if (enabled) {
                content.classList.add('reader-mode');
            } else {
                content.classList.remove('reader-mode');
            }

            localStorage.setItem('readerMode', enabled);
        }

        // Recent files management
        function getRecentFiles() {
            const recent = localStorage.getItem('recentFiles');
            return recent ? JSON.parse(recent) : [];
        }

        function addToRecentFiles(filePath) {
            if (!filePath) return;

            let recentFiles = getRecentFiles();
            // Remove if already exists
            recentFiles = recentFiles.filter(f => f.path !== filePath);
            // Add to front with timestamp
            recentFiles.unshift({
                path: filePath,
                timestamp: Date.now()
            });
            // Limit to 10 most recent
            recentFiles = recentFiles.slice(0, 10);
            localStorage.setItem('recentFiles', JSON.stringify(recentFiles));
        }

        function getFileBasename(path) {
            if (!path) return '';
            const parts = path.split('/');
            return parts[parts.length - 1];
        }

        function getFileDirectory(path) {
            if (!path) return '';
            const parts = path.split('/');
            if (parts.length <= 1) return '';
            return parts.slice(0, -1).join('/');
        }

        function updateFilePathBar(filePath, gitRoot) {
            const pathBar = document.getElementById('file-path-bar');
            if (!pathBar) return;

            if (filePath) {
                pathBar.style.display = 'block';
                pathBar.title = `Click to copy: ${filePath}`;

                if (gitRoot && filePath.startsWith(gitRoot)) {
                    // Extract git root directory name
                    const gitRootName = gitRoot.split('/').filter(p => p).pop() || gitRoot;
                    // Get relative path from git root
                    const relativePath = filePath.substring(gitRoot.length);

                    // Build HTML with styled parts
                    pathBar.innerHTML = `<span class="git-root">${gitRootName}</span><span class="path-separator">/</span><span class="relative-path">${relativePath.replace(/^\//, '')}</span>`;
                } else {
                    // No git root found, show full path
                    pathBar.textContent = filePath;
                }
            } else {
                pathBar.style.display = 'none';
            }
        }

        function showToast(message, subtitle = null, duration = 2000) {
            // Create toast element
            const toast = document.createElement('div');
            toast.className = 'toast';

            if (subtitle) {
                // Create title element
                const titleDiv = document.createElement('div');
                titleDiv.className = 'toast-title';
                titleDiv.textContent = message;
                toast.appendChild(titleDiv);

                // Create path element
                const pathDiv = document.createElement('div');
                pathDiv.className = 'toast-path';
                pathDiv.textContent = subtitle;
                toast.appendChild(pathDiv);
            } else {
                toast.textContent = message;
            }

            document.body.appendChild(toast);

            // Show toast with animation
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);

            // Hide and remove toast after duration
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, duration);
        }

        function copyToClipboard(text) {
            // Use the Clipboard API if available
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    console.log('Copied to clipboard:', text);
                    showToast('Copied: ' + getFileBasename(text), text);
                }).catch(err => {
                    console.error('Failed to copy to clipboard:', err);
                    showToast('Failed to copy to clipboard');
                });
            } else {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    console.log('Copied to clipboard:', text);
                    showToast('Copied: ' + getFileBasename(text), text);
                } catch (err) {
                    console.error('Failed to copy to clipboard:', err);
                    showToast('Failed to copy to clipboard');
                }
                document.body.removeChild(textArea);
            }
        }

        function renderRecentFiles() {
            const container = document.getElementById('recent-files');
            if (!container) return;

            const recentFiles = getRecentFiles();

            if (recentFiles.length === 0) {
                container.innerHTML = '<div class="no-recent-files">No recent files</div>';
                return;
            }

            container.innerHTML = '';
            recentFiles.forEach(file => {
                const item = document.createElement('div');
                item.className = 'recent-file-item';
                if (file.path === currentFilePath) {
                    item.classList.add('current');
                }

                // Create filename element
                const nameElement = document.createElement('div');
                nameElement.className = 'recent-file-name';
                nameElement.textContent = getFileBasename(file.path);

                // Create path element
                const pathElement = document.createElement('div');
                pathElement.className = 'recent-file-path';
                pathElement.textContent = getFileDirectory(file.path);
                pathElement.title = file.path;

                item.appendChild(nameElement);
                item.appendChild(pathElement);

                // Left click to switch file
                item.onclick = (e) => {
                    // If shift key is held, copy to clipboard instead of switching
                    if (e.shiftKey) {
                        copyToClipboard(file.path);
                        e.stopPropagation();
                        return;
                    }
                    switchToFile(file.path);
                };

                // Right click to copy to clipboard
                item.oncontextmenu = (e) => {
                    e.preventDefault();
                    copyToClipboard(file.path);
                };

                container.appendChild(item);
            });
        }

        function switchToFile(filePath) {
            if (filePath === currentFilePath) {
                return;  // Already viewing this file
            }

            if (!websocket || websocket.readyState !== WebSocket.OPEN) {
                console.error('WebSocket not connected');
                return;
            }

            // Send switch file request to Rust backend
            const request = {
                type: 'switch_file',
                file_path: filePath
            };

            websocket.send(JSON.stringify(request));
            console.log(`Switching to: ${filePath}`);
        }

        // Set up TOC resize functionality
        function setupTOCResize() {
            const tocPanel = document.getElementById('toc-panel');
            const resizeHandle = document.querySelector('.toc-resize-handle');
            let isResizing = false;
            let startX = 0;
            let startWidth = 0;

            resizeHandle.addEventListener('mousedown', (e) => {
                isResizing = true;
                startX = e.clientX;
                startWidth = tocPanel.offsetWidth;
                resizeHandle.classList.add('resizing');
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
                e.preventDefault();
            });

            document.addEventListener('mousemove', (e) => {
                if (!isResizing) return;

                const delta = e.clientX - startX;
                // For right-side TOC, delta should be negative to increase width
                // For left-side TOC, delta should be positive to increase width
                const isRightSide = tocPanel.classList.contains('toc-right');
                const newWidth = isRightSide ? startWidth - delta : startWidth + delta;
                const minWidth = 150;
                const maxWidth = 500;

                if (newWidth >= minWidth && newWidth <= maxWidth) {
                    tocPanel.style.width = newWidth + 'px';
                }
            });

            document.addEventListener('mouseup', () => {
                if (isResizing) {
                    isResizing = false;
                    resizeHandle.classList.remove('resizing');
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';
                    // Save the new width
                    localStorage.setItem('tocWidth', tocPanel.offsetWidth);
                }
            });
        }

        document.addEventListener('DOMContentLoaded', (event) => {
            // Restore saved preferences
            const savedMode = localStorage.getItem('lineNumberMode') || 'off';
            lineNumberMode = savedMode;
            document.getElementById('line-numbers-mode').value = savedMode;

            // For TOC, use saved preference if exists, otherwise default to right for wide monitors
            const savedTOCMode = localStorage.getItem('tocMode');
            let tocMode = 'off';
            if (savedTOCMode) {
                tocMode = savedTOCMode;
            } else if (window.innerWidth >= 1440) {
                // Default to right for monitors >= 1440px
                tocMode = 'right';
            }
            document.getElementById('toc-mode').value = tocMode;

            const savedFont = localStorage.getItem('fontFamily') || 'default';
            fontFamily = savedFont;
            document.getElementById('font-family').value = savedFont;

            const savedReaderMode = localStorage.getItem('readerMode') === 'true';
            readerMode = savedReaderMode;
            document.getElementById('reader-mode').value = savedReaderMode ? 'on' : 'off';

            // Set up line number mode change listener
            document.getElementById('line-numbers-mode').addEventListener('change', (e) => {
                changeLineNumberMode(e.target.value);
            });

            // Set up TOC toggle listener
            document.getElementById('toc-mode').addEventListener('change', (e) => {
                toggleTOC(e.target.value);
            });

            // Set up font family change listener
            document.getElementById('font-family').addEventListener('change', (e) => {
                changeFontFamily(e.target.value);
            });

            // Set up reader mode change listener
            document.getElementById('reader-mode').addEventListener('change', (e) => {
                toggleReaderMode(e.target.value === 'on');
            });

            // Set up file path bar click-to-copy
            document.getElementById('file-path-bar').addEventListener('click', () => {
                if (currentFilePath) {
                    copyToClipboard(currentFilePath);
                }
            });

            // Set up TOC resize functionality
            setupTOCResize();

            document.querySelectorAll('pre code').forEach((el) => {
                hljs.highlightElement(el);
            });

            codeHighlight();
            renderMermaid();
            applyLineNumberMode(lineNumberMode, currentSourceLines, currentLineMap);

            // Initialize TOC with saved mode
            if (tocMode !== 'off') {
                toggleTOC(tocMode);
            }

            // Apply saved font family
            changeFontFamily(fontFamily);

            // Apply saved reader mode
            if (readerMode) {
                toggleReaderMode(true);
            }

            // Initialize recent files display
            renderRecentFiles();

            const webSocketUrl = 'ws://' + window.location.host;
            websocket = new WebSocket(webSocketUrl);
            var socket = websocket;  // Keep local reference for compatibility

            // Handle WebSocket events...
            socket.onmessage = function(event) {
                const message = JSON.parse(event.data);

                if (message.type === "update_content") {
                    document.getElementById('content').innerHTML = message.data;

                    // Add spacer at the end for better scrolling
                    const spacer = document.createElement('div');
                    spacer.style.height = '100px';
                    spacer.style.pointerEvents = 'none';
                    document.getElementById('content').appendChild(spacer);

                    // Debug: log first 10 children
                    const debugChildren = Array.from(document.getElementById('content').children).slice(0, 10);
                    console.log('First 10 HTML children:', debugChildren.map((c, i) => `${i}: ${c.tagName}`));
                    console.log('Line map (first 10):', message.line_map?.slice(0, 10));

                    codeHighlight();
                    // Render LaTeX inside content
                    renderMathInElement(document.getElementById('content'), {
                        delimiters: [
                            {left: "$$", right: "$$", display: true},
                            {left: "$", right: "$", display: false}
                        ]
                    });
                    // Render mermaid diagrams
                    renderMermaid();
                    // Apply line numbers with source line count and line map
                    applyLineNumberMode(lineNumberMode, message.source_lines, message.line_map);
                    // Regenerate TOC if visible
                    if (tocVisible) {
                        generateTOC();
                    }
                    // Update file path and recent files if provided
                    if (message.file_path) {
                        currentFilePath = message.file_path;
                        addToRecentFiles(currentFilePath);
                        renderRecentFiles();
                        updateFilePathBar(currentFilePath, message.git_root);
                    }
                    // Focus window if requested
                    if (message.should_focus) {
                        window.focus();
                    }
                } else if (message.type === "scroll") {
                    const scrollPercent = message.data;

                    // Calculate the absolute scroll position based on the percentage
                    const windowHeight = window.innerHeight;
                    const totalScrollHeight = document.documentElement.scrollHeight - windowHeight;
                    const absoluteScrollPosition = totalScrollHeight * (scrollPercent / 100);

                    // Scroll the page to the calculated absolute position
                    window.scrollTo(0, absoluteScrollPosition);
                } else if (message.type === "focus_window") {
                    // Bring the browser window to the foreground
                    window.focus();
                } else {
                    console.log(`Invalid message: {message}`)
                }
            }

            socket.onclose = function(event) {
                // Close the browser window when WebSocket closes
                // This happens when Vim exits or the server shuts down
                console.log(`WebSocket closed with code ${event.code}. Closing browser.`);
                window.open('', '_self', '');
                window.close();
            }

            socket.onerror = function(error) {
                console.error('WebSocket error:', error);
            }
        });
    </script>
</body>
</html>
