<!DOCTYPE html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500&family=Inter:wght@400;500;600;700&family=Literata:ital,opsz,wght@0,7..72,400;0,7..72,500;0,7..72,600;0,7..72,700;1,7..72,400;1,7..72,500&family=Merriweather:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.5.1/github-markdown.min.css" >
    <!-- GitHub Alerts styling from markdown-it-github-alerts
         Source: https://github.com/antfu/markdown-it-github-alerts
         These styles are extracted from GitHub's official alert implementation -->
    <link rel="stylesheet" href="https://unpkg.com/markdown-it-github-alerts@0.3.0/styles/github-base.css">
    <link rel="stylesheet" href="https://unpkg.com/markdown-it-github-alerts@0.3.0/styles/github-colors-light.css">
    <link rel="stylesheet" href="https://unpkg.com/markdown-it-github-alerts@0.3.0/styles/github-colors-dark-media.css">
    <!-- Code highlight -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <!-- and it's easy to individually load additional languages -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/go.min.js"></script>

    <!-- KaTeX CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">

    <!-- KaTeX Auto-render extension + KaTeX main -->
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js"></script>

    <!-- Mermaid -->
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: false });
        window.mermaid = mermaid;
    </script>

    <style>
/* Base styles for markdown preview */
      body {
        margin: 0;
        padding: 0;
        display: flex;
        height: 100vh;
        overflow: hidden;
      }

      #sidebar {
        width: 250px;
        background: #f6f8fa;
        border-right: 1px solid #d0d7de;
        padding: 20px;
        box-sizing: border-box;
        overflow-y: auto;
        flex-shrink: 0;
        order: 1;
      }

      #sidebar h3 {
        margin: 0 0 15px 0;
        font-size: 14px;
        font-weight: 600;
        color: #24292f;
      }

      .sidebar-section {
        margin-bottom: 20px;
      }

      .recent-files {
        max-height: 200px;
        overflow-y: auto;
      }

      .recent-file-item {
        padding: 6px 8px;
        margin: 4px 0;
        background: #ffffff;
        border: 1px solid #d0d7de;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      .recent-file-item:hover {
        background: #f0f6fc;
        border-color: #0969da;
      }

      .recent-file-item.current {
        background: #e6f2ff;
        border-color: #0969da;
      }

      .recent-file-name {
        font-size: 13px;
        font-weight: 600;
        color: #24292f;
      }

      .recent-file-item:hover .recent-file-name {
        color: #0969da;
      }

      .recent-file-item.current .recent-file-name {
        color: #0969da;
      }

      .recent-file-path {
        font-size: 11px;
        color: #8b949e;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .recent-file-item:hover .recent-file-path {
        color: #6e7781;
      }

      .no-recent-files {
        padding: 8px;
        font-size: 12px;
        color: #8b949e;
        font-style: italic;
      }

      /* Path tooltip */
      .path-tooltip {
        position: fixed;
        z-index: 10001;
        pointer-events: none;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.15s, visibility 0.15s;
      }

      .path-tooltip.visible {
        opacity: 1;
        visibility: visible;
      }

      .path-tooltip-content {
        background: #f6f8fa;
        color: #24292f;
        padding: 6px 10px;
        border: 1px solid #d0d7de;
        border-radius: 6px;
        font-size: 12px;
        font-family: ui-monospace, SFMono-Regular, "SF Mono", Menlo, monospace;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12);
        max-width: 700px;
        word-break: break-all;
        line-height: 1.4;
      }

      .path-tooltip-sep {
        color: #8b949e;
      }

      .path-tooltip-file {
        color: #24292f;
        font-weight: 500;
      }

      .option-group {
        padding: 8px 0;
      }

      .option-label {
        display: block;
        font-size: 13px;
        color: #57606a;
        margin-bottom: 6px;
        font-weight: 500;
      }

      .option-select {
        width: 100%;
        padding: 6px 8px;
        font-size: 13px;
        border: 1px solid #d0d7de;
        border-radius: 6px;
        background-color: #ffffff;
        color: #24292f;
        cursor: pointer;
        transition: border-color 0.2s;
      }

      .option-select:hover {
        border-color: #8c959f;
      }

      .option-select:focus {
        outline: none;
        border-color: #0969da;
        box-shadow: 0 0 0 3px rgba(9, 105, 218, 0.1);
      }

      .document-stats {
        background: #ffffff;
        border: 1px solid #d0d7de;
        border-radius: 6px;
        padding: 12px;
      }

      .stat-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 6px 0;
        border-bottom: 1px solid #eaecef;
      }

      .stat-row:last-child {
        border-bottom: none;
        padding-bottom: 0;
      }

      .stat-row:first-child {
        padding-top: 0;
      }

      .stat-label {
        font-size: 13px;
        color: #57606a;
      }

      .stat-value {
        font-size: 13px;
        font-weight: 600;
        color: #24292f;
        font-family: ui-monospace, SFMono-Regular, "SF Mono", Menlo, Consolas, monospace;
      }

      #toc-panel {
        width: 250px; /* Default, will be adjusted based on screen size */
        min-width: 150px;
        max-width: 500px;
        background: #f6f8fa;
        padding: 20px;
        box-sizing: border-box;
        overflow-y: auto;
        flex-shrink: 0;
        display: none;
        position: relative;
        order: 2; /* Default position between sidebar and content */
      }

      #toc-panel.visible {
        display: block;
      }

      /* Left-side TOC (default) */
      #toc-panel.toc-left {
        border-right: 1px solid #d0d7de;
        border-left: none;
        order: 2;
      }

      #toc-panel.toc-left .toc-resize-handle {
        right: 0;
        left: auto;
      }

      /* Right-side TOC */
      #toc-panel.toc-right {
        border-left: 1px solid #d0d7de;
        border-right: none;
        order: 4;
      }

      #toc-panel.toc-right .toc-resize-handle {
        left: 0;
        right: auto;
      }

      .toc-resize-handle {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 5px;
        cursor: col-resize;
        background: transparent;
        transition: background 0.2s;
      }

      .toc-resize-handle:hover {
        background: #0969da;
      }

      .toc-resize-handle.resizing {
        background: #0969da;
      }

      .toc-header {
        font-size: 14px;
        font-weight: 600;
        color: #24292f;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid #d0d7de;
      }

      .toc-content {
        font-size: 14px;
      }

      .toc-content a {
        display: block;
        color: #57606a;
        text-decoration: none;
        padding: 6px 8px;
        margin: 2px 0;
        border-radius: 6px;
        transition: all 0.2s;
        border-left: 3px solid transparent;
      }

      .toc-content a:hover {
        color: #0969da;
        background: #f0f6fc;
        border-left-color: #0969da;
      }

      .toc-content .toc-h1 {
        font-weight: 700;
        font-size: 15px;
        margin-top: 12px;
        padding: 8px 10px;
        color: #24292f;
        background: #eff2f5;
        border-left: 4px solid #0969da;
      }

      .toc-content .toc-h1:hover {
        background: #e6ebf1;
      }

      .toc-content .toc-h2 {
        padding-left: 20px;
        font-weight: 600;
        font-size: 14px;
        color: #1f2328;
      }

      .toc-content .toc-h3 {
        padding-left: 32px;
        font-size: 13px;
        font-weight: 500;
      }

      .toc-content .toc-h4 {
        padding-left: 44px;
        font-size: 13px;
        font-weight: 400;
        opacity: 0.9;
      }

      .toc-content .toc-h5,
      .toc-content .toc-h6 {
        padding-left: 56px;
        font-size: 12px;
        opacity: 0.8;
      }

      #main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        order: 3;
        overflow-y: auto;
      }

      #main-content > .markdown-body {
        flex: 0 1 auto;
        align-self: center;
      }

      .markdown-body {
        box-sizing: border-box;
        min-width: 200px;
        max-width: 980px;
        width: 100%;
        padding: 45px;
        position: relative;
      }

      /* GitHub-style heading anchor links */
      .heading-anchor {
        color: #0969da;
        opacity: 0;
        margin-left: -24px;
        padding-right: 8px;
        text-decoration: none;
        transition: opacity 0.2s;
        display: inline-flex;
        align-items: center;
      }

      .heading-anchor:hover {
        opacity: 1 !important;
      }

      .heading-anchor .octicon {
        fill: currentColor;
        vertical-align: middle;
      }

      h1:hover .heading-anchor,
      h2:hover .heading-anchor,
      h3:hover .heading-anchor,
      h4:hover .heading-anchor,
      h5:hover .heading-anchor,
      h6:hover .heading-anchor {
        opacity: 0.6;
      }

      /* Ensure proper heading layout with anchor */
      .markdown-body h1,
      .markdown-body h2,
      .markdown-body h3,
      .markdown-body h4,
      .markdown-body h5,
      .markdown-body h6 {
        scroll-margin-top: 20px;
      }

      @media (prefers-color-scheme: dark) {
        .heading-anchor {
          color: #58a6ff;
        }
      }

      /* Font family options */
      .markdown-body.font-serif {
        font-family: "Palatino Linotype", Palatino, Palladio, "URW Palladio L", "Book Antiqua", Baskerville, "Bookman Old Style", "Bitstream Charter", "Nimbus Roman No9 L", Garamond, "Apple Garamond", "ITC Garamond Narrow", "New Century Schoolbook", "Century Schoolbook", "Century Schoolbook L", Georgia, serif;
      }

      .markdown-body.font-serif h1,
      .markdown-body.font-serif h2,
      .markdown-body.font-serif h3,
      .markdown-body.font-serif h4,
      .markdown-body.font-serif h5,
      .markdown-body.font-serif h6 {
        font-family: "Palatino Linotype", Palatino, Georgia, serif;
      }

      .markdown-body.font-mono {
        font-family: ui-monospace, SFMono-Regular, "SF Mono", Menlo, Consolas, "Liberation Mono", monospace;
        font-size: 13px;
        line-height: 1.6;
      }

      .markdown-body.font-system {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans", Helvetica, Arial, sans-serif;
      }

      .markdown-body.font-inter {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        letter-spacing: -0.011em;
      }

      .markdown-body.font-inter h1,
      .markdown-body.font-inter h2,
      .markdown-body.font-inter h3,
      .markdown-body.font-inter h4,
      .markdown-body.font-inter h5,
      .markdown-body.font-inter h6 {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        letter-spacing: -0.02em;
      }

      .markdown-body.font-merriweather {
        font-family: "Merriweather", Georgia, "Times New Roman", serif;
        font-size: 17px;
        line-height: 1.75;
      }

      .markdown-body.font-merriweather h1,
      .markdown-body.font-merriweather h2,
      .markdown-body.font-merriweather h3,
      .markdown-body.font-merriweather h4,
      .markdown-body.font-merriweather h5,
      .markdown-body.font-merriweather h6 {
        font-family: "Merriweather", Georgia, serif;
      }

      .markdown-body.font-ibm-plex {
        font-family: "IBM Plex Sans", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      }

      .markdown-body.font-ibm-plex h1,
      .markdown-body.font-ibm-plex h2,
      .markdown-body.font-ibm-plex h3,
      .markdown-body.font-ibm-plex h4,
      .markdown-body.font-ibm-plex h5,
      .markdown-body.font-ibm-plex h6 {
        font-family: "IBM Plex Sans", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      }

      .markdown-body.font-literata {
        font-family: "Literata", Georgia, "Times New Roman", serif;
        font-size: 17px;
        line-height: 1.7;
        font-optical-sizing: auto;
      }

      .markdown-body.font-literata h1,
      .markdown-body.font-literata h2,
      .markdown-body.font-literata h3,
      .markdown-body.font-literata h4,
      .markdown-body.font-literata h5,
      .markdown-body.font-literata h6 {
        font-family: "Literata", Georgia, serif;
      }

      /* Reader Mode - optimized for focused reading */
      .markdown-body.reader-mode {
        max-width: 750px;
        font-size: 18px;
        line-height: 1.7;
      }

      .markdown-body.reader-mode p {
        margin-top: 1.2em;
        margin-bottom: 1.2em;
      }

      .markdown-body.reader-mode h1 {
        margin-top: 1.5em;
        margin-bottom: 0.8em;
      }

      .markdown-body.reader-mode h2 {
        margin-top: 1.3em;
        margin-bottom: 0.7em;
      }

      .markdown-body.reader-mode h3,
      .markdown-body.reader-mode h4,
      .markdown-body.reader-mode h5,
      .markdown-body.reader-mode h6 {
        margin-top: 1.2em;
        margin-bottom: 0.6em;
      }

      .markdown-body.reader-mode ul,
      .markdown-body.reader-mode ol {
        margin-top: 1em;
        margin-bottom: 1em;
      }

      .markdown-body.reader-mode li {
        margin-top: 0.4em;
        margin-bottom: 0.4em;
      }

      .markdown-body.reader-mode blockquote {
        margin-top: 1.2em;
        margin-bottom: 1.2em;
      }

      .markdown-body.reader-mode pre {
        margin-top: 1.2em;
        margin-bottom: 1.2em;
      }

      /* Markdown content line numbers */
      .markdown-body.show-line-numbers {
        padding-left: 90px;
      }

      .markdown-body.show-line-numbers > * {
        position: relative;
      }

      /* Single line number (rendered or source) */
      .markdown-body.show-line-numbers > *::before {
        content: attr(data-line-number);
        position: absolute;
        left: -60px;
        width: 40px;
        text-align: right;
        color: #999;
        font-size: 12px;
        user-select: none;
        padding-right: 10px;
        font-family: monospace;
      }

      /* Both line numbers mode */
      .markdown-body.show-line-numbers-both {
        padding-left: 110px;
      }

      .markdown-body.show-line-numbers-both > * {
        position: relative;
      }

      .markdown-body.show-line-numbers-both > *::before {
        content: attr(data-rendered-number) " / " attr(data-source-number);
        position: absolute;
        left: -90px;
        width: 70px;
        text-align: right;
        color: #999;
        font-size: 11px;
        user-select: none;
        padding-right: 10px;
        font-family: monospace;
      }

      @media (prefers-color-scheme: dark) {
        body {
          background: #0d1117;
        }

        #sidebar {
          background: #161b22;
          border-right-color: #30363d;
        }

        #sidebar h3 {
          color: #c9d1d9;
        }

        .option-label {
          color: #8b949e;
        }

        .option-select {
          background-color: #0d1117;
          border-color: #30363d;
          color: #c9d1d9;
        }

        .option-select:hover {
          border-color: #6e7681;
        }

        .option-select:focus {
          border-color: #58a6ff;
          box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.1);
        }

        .recent-file-item {
          background: #0d1117;
          border-color: #30363d;
        }

        .recent-file-item:hover {
          background: #1c2128;
          border-color: #58a6ff;
        }

        .recent-file-item.current {
          background: #1c2d41;
          border-color: #58a6ff;
        }

        .recent-file-name {
          color: #c9d1d9;
        }

        .recent-file-item:hover .recent-file-name,
        .recent-file-item.current .recent-file-name {
          color: #58a6ff;
        }

        .recent-file-path {
          color: #6e7781;
        }

        .recent-file-item:hover .recent-file-path {
          color: #8b949e;
        }

        .markdown-body.show-line-numbers > *::before,
        .markdown-body.show-line-numbers-both > *::before {
          color: #6e7681;
        }

        .document-stats {
          background: #0d1117;
          border-color: #30363d;
        }

        .stat-row {
          border-bottom-color: #21262d;
        }

        .stat-label {
          color: #8b949e;
        }

        .stat-value {
          color: #c9d1d9;
        }

        #toc-panel {
          background: #161b22;
        }

        #toc-panel.toc-left {
          border-right-color: #30363d;
        }

        #toc-panel.toc-right {
          border-left-color: #30363d;
        }

        .toc-header {
          color: #c9d1d9;
          border-bottom-color: #30363d;
        }

        .toc-content a {
          color: #8b949e;
        }

        .toc-content a:hover {
          color: #58a6ff;
          background: #1c2128;
          border-left-color: #58a6ff;
        }

        .toc-content .toc-h1 {
          color: #c9d1d9;
          background: #21262d;
          border-left-color: #58a6ff;
        }

        .toc-content .toc-h1:hover {
          background: #2d333b;
        }

        .toc-content .toc-h2 {
          color: #c9d1d9;
        }

        .toc-resize-handle:hover,
        .toc-resize-handle.resizing {
          background: #58a6ff;
        }
      }

      @media (max-width: 767px) {
        body {
          flex-direction: column;
        }

        #sidebar {
          width: 100%;
          border-right: none;
          border-bottom: 1px solid #d0d7de;
        }

        .markdown-body {
          padding: 15px;
        }
      }

      /* File path bar */
      .file-path-bar {
        background: #f6f8fa;
        border-bottom: 1px solid #d0d7de;
        padding: 8px 20px 18px 20px;
        font-family: ui-monospace, SFMono-Regular, "SF Mono", Menlo, Consolas, "Liberation Mono", monospace;
        font-size: 13px;
        line-height: 1;
        color: #57606a;
        cursor: pointer;
        user-select: none;
        transition: background 0.2s;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .file-path-bar:hover {
        background: #eef2f6;
      }

      .file-path-bar:active {
        background: #e6ebf1;
      }

      .git-root {
        color: #0969da;
        font-weight: 600;
        vertical-align: baseline;
      }

      .file-path-bar:hover .git-root {
        color: #0550ae;
      }

      .relative-path {
        color: #57606a;
        font-weight: 400;
      }

      .file-path-bar:hover .relative-path {
        color: #24292f;
      }

      .path-separator {
        color: #8b949e;
        margin: 0 2px;
      }

      @media (prefers-color-scheme: dark) {
        .file-path-bar {
          background: #161b22;
          border-bottom-color: #30363d;
          color: #8b949e;
        }

        .file-path-bar:hover {
          background: #1c2128;
        }

        .file-path-bar:active {
          background: #21262d;
        }

        .git-root {
          color: #58a6ff;
        }

        .file-path-bar:hover .git-root {
          color: #79c0ff;
        }

        .relative-path {
          color: #8b949e;
        }

        .file-path-bar:hover .relative-path {
          color: #c9d1d9;
        }

        .path-separator {
          color: #6e7681;
        }
      }

      /* Toast notification for clipboard */
      .toast {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%) translateY(-20px);
        background: #0969da;
        color: #ffffff;
        padding: 16px 32px;
        border-radius: 8px;
        box-shadow: 0 8px 24px rgba(9, 105, 218, 0.5);
        font-size: 16px;
        font-weight: 600;
        z-index: 10000;
        opacity: 0;
        transition: opacity 0.3s, transform 0.3s;
        pointer-events: none;
        min-width: 250px;
        max-width: 600px;
        text-align: center;
      }

      .toast-title {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 6px;
      }

      .toast-path {
        font-size: 12px;
        font-weight: 400;
        opacity: 0.9;
        word-break: break-all;
      }

      .toast.show {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }

      @media (prefers-color-scheme: dark) {
        .toast {
          background: #58a6ff;
          color: #0d1117;
          box-shadow: 0 8px 24px rgba(88, 166, 255, 0.5);
        }
      }

      /* Fuzzy Finder Styles */
      .fuzzy-finder-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 20000;
        display: none;
        justify-content: center;
        align-items: flex-start;
        padding-top: 15vh;
      }

      .fuzzy-finder-overlay.visible {
        display: flex;
      }

      .fuzzy-finder-container {
        width: 600px;
        max-width: 90vw;
        max-height: 70vh;
        background: #ffffff;
        border-radius: 12px;
        box-shadow: 0 16px 70px rgba(0, 0, 0, 0.2);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        animation: fuzzy-slide-in 0.15s ease-out;
      }

      @keyframes fuzzy-slide-in {
        from {
          opacity: 0;
          transform: translateY(-10px) scale(0.98);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      .fuzzy-finder-header {
        padding: 16px;
        border-bottom: 1px solid #e1e4e8;
      }

      .fuzzy-finder-input-wrapper {
        display: flex;
        align-items: center;
        background: #f6f8fa;
        border: 1px solid #d0d7de;
        border-radius: 8px;
        padding: 8px 12px;
        transition: border-color 0.2s, box-shadow 0.2s;
      }

      .fuzzy-finder-input-wrapper:focus-within {
        border-color: #0969da;
        box-shadow: 0 0 0 3px rgba(9, 105, 218, 0.1);
        background: #ffffff;
      }

      .fuzzy-finder-icon {
        fill: #57606a;
        margin-right: 10px;
        flex-shrink: 0;
      }

      .fuzzy-finder-input {
        flex: 1;
        border: none;
        background: transparent;
        font-size: 16px;
        color: #24292f;
        outline: none;
      }

      .fuzzy-finder-input::placeholder {
        color: #8b949e;
      }

      .fuzzy-finder-mode-toggle {
        display: flex;
        gap: 4px;
        margin-left: 10px;
      }

      .fuzzy-mode-btn {
        width: 28px;
        height: 28px;
        border: 1px solid #d0d7de;
        border-radius: 6px;
        background: #ffffff;
        color: #57606a;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.15s;
      }

      .fuzzy-mode-btn:hover {
        background: #f3f4f6;
        border-color: #8b949e;
      }

      .fuzzy-mode-btn.active {
        background: #0969da;
        border-color: #0969da;
        color: #ffffff;
      }

      .fuzzy-finder-hint {
        margin-top: 10px;
        font-size: 12px;
        color: #8b949e;
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
      }

      .fuzzy-finder-hint .key {
        background: #eff2f5;
        padding: 2px 6px;
        border-radius: 4px;
        font-family: ui-monospace, SFMono-Regular, "SF Mono", Menlo, monospace;
        font-size: 11px;
        color: #57606a;
        margin-right: 4px;
      }

      .fuzzy-finder-results {
        flex: 1;
        overflow-y: auto;
        min-height: 100px;
        max-height: 400px;
      }

      .fuzzy-result-item {
        padding: 10px 16px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
        transition: background 0.1s;
      }

      .fuzzy-result-item:hover {
        background: #f6f8fa;
      }

      .fuzzy-result-item.selected {
        background: #0969da;
        color: #ffffff;
      }

      .fuzzy-result-item.selected .fuzzy-result-type,
      .fuzzy-result-item.selected .fuzzy-result-context {
        color: rgba(255, 255, 255, 0.8);
      }

      .fuzzy-result-item.selected .fuzzy-match {
        background: rgba(255, 255, 255, 0.3);
        color: #ffffff;
      }

      .fuzzy-result-title {
        font-size: 14px;
        font-weight: 500;
        margin-bottom: 4px;
        line-height: 1.4;
      }

      .fuzzy-result-context {
        font-size: 12px;
        color: #8b949e;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .fuzzy-result-type {
        font-size: 11px;
        color: #8b949e;
        background: #eff2f5;
        padding: 2px 6px;
        border-radius: 4px;
        margin-right: 8px;
        font-weight: 500;
      }

      .fuzzy-result-item.selected .fuzzy-result-type {
        background: rgba(255, 255, 255, 0.2);
      }

      .fuzzy-match {
        background: #fff8c5;
        color: #24292f;
        border-radius: 2px;
        padding: 0 1px;
      }

      .fuzzy-finder-footer {
        padding: 10px 16px;
        border-top: 1px solid #e1e4e8;
        font-size: 12px;
        color: #8b949e;
        background: #f6f8fa;
      }

      .fuzzy-no-results {
        padding: 40px 16px;
        text-align: center;
        color: #8b949e;
        font-size: 14px;
      }

      /* Dark mode for fuzzy finder */
      @media (prefers-color-scheme: dark) {
        .fuzzy-finder-overlay {
          background: rgba(0, 0, 0, 0.7);
        }

        .fuzzy-finder-container {
          background: #161b22;
          box-shadow: 0 16px 70px rgba(0, 0, 0, 0.5);
        }

        .fuzzy-finder-header {
          border-bottom-color: #30363d;
        }

        .fuzzy-finder-input-wrapper {
          background: #0d1117;
          border-color: #30363d;
        }

        .fuzzy-finder-input-wrapper:focus-within {
          border-color: #58a6ff;
          box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.1);
          background: #0d1117;
        }

        .fuzzy-finder-icon {
          fill: #8b949e;
        }

        .fuzzy-finder-input {
          color: #c9d1d9;
        }

        .fuzzy-finder-input::placeholder {
          color: #6e7681;
        }

        .fuzzy-mode-btn {
          background: #21262d;
          border-color: #30363d;
          color: #8b949e;
        }

        .fuzzy-mode-btn:hover {
          background: #30363d;
          border-color: #8b949e;
        }

        .fuzzy-mode-btn.active {
          background: #58a6ff;
          border-color: #58a6ff;
          color: #0d1117;
        }

        .fuzzy-finder-hint .key {
          background: #21262d;
          color: #8b949e;
        }

        .fuzzy-result-item {
          border-bottom-color: #21262d;
        }

        .fuzzy-result-item:hover {
          background: #21262d;
        }

        .fuzzy-result-item.selected {
          background: #58a6ff;
          color: #0d1117;
        }

        .fuzzy-result-title {
          color: #c9d1d9;
        }

        .fuzzy-result-item.selected .fuzzy-result-title {
          color: #0d1117;
        }

        .fuzzy-result-context {
          color: #6e7681;
        }

        .fuzzy-result-type {
          background: #21262d;
          color: #8b949e;
        }

        .fuzzy-match {
          background: #634d00;
          color: #c9d1d9;
        }

        .fuzzy-result-item.selected .fuzzy-match {
          background: rgba(0, 0, 0, 0.2);
          color: #0d1117;
        }

        .fuzzy-finder-footer {
          border-top-color: #30363d;
          background: #0d1117;
          color: #6e7681;
        }

        .fuzzy-no-results {
          color: #6e7681;
        }
      }

      /* ==================== Zoom Controls ==================== */
      .zoom-controls {
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .zoom-btn {
        width: 28px;
        height: 28px;
        padding: 0;
        border: 1px solid #d0d7de;
        border-radius: 6px;
        background: #ffffff;
        color: #24292f;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.15s ease;
      }

      .zoom-btn:hover {
        background: #f3f4f6;
        border-color: #0969da;
      }

      .zoom-btn:active {
        background: #e6f2ff;
      }

      .zoom-btn.zoom-reset {
        width: auto;
        padding: 0 10px;
        font-size: 12px;
      }

      .zoom-display {
        min-width: 45px;
        text-align: center;
        font-size: 13px;
        font-weight: 500;
        color: #24292f;
      }

      /* Dark mode zoom controls */
      @media (prefers-color-scheme: dark) {
        .zoom-btn {
          background: #21262d;
          border-color: #30363d;
          color: #c9d1d9;
        }

        .zoom-btn:hover {
          background: #30363d;
          border-color: #58a6ff;
        }

        .zoom-btn:active {
          background: #388bfd26;
        }

        .zoom-display {
          color: #c9d1d9;
        }
      }

      /* ============================================
         Theme Overrides (MarkText-inspired themes)
         ============================================ */

      /* Theme: Dark (MarkText Dark) */
      body.theme-dark {
        background: #282828;
      }
      body.theme-dark #sidebar {
        background: #1e1e1e;
        border-right-color: #363839;
      }
      body.theme-dark #sidebar h3 {
        color: rgba(255, 255, 255, .8);
      }
      body.theme-dark .option-label {
        color: rgba(255, 255, 255, .6);
      }
      body.theme-dark .option-select {
        background-color: #424344;
        border-color: rgba(0, 0, 0, 0.2);
        color: rgba(255, 255, 255, .7);
      }
      body.theme-dark .option-select:hover {
        border-color: rgba(0, 0, 0, 0.3);
      }
      body.theme-dark .option-select:focus {
        border-color: #409eff;
        box-shadow: 0 0 0 3px rgba(64, 158, 255, 0.2);
      }
      body.theme-dark .document-stats {
        background: #424344;
        border-color: #363839;
      }
      body.theme-dark .stat-row {
        border-bottom-color: #363839;
      }
      body.theme-dark .stat-label {
        color: rgba(255, 255, 255, .5);
      }
      body.theme-dark .stat-value {
        color: rgba(255, 255, 255, .8);
      }
      body.theme-dark .recent-file-item {
        background: #424344;
        border-color: #363839;
      }
      body.theme-dark .recent-file-item:hover {
        background: #4f5051;
        border-color: #409eff;
      }
      body.theme-dark .recent-file-item.current {
        background: #3a4a5a;
        border-color: #409eff;
      }
      body.theme-dark .recent-file-name {
        color: rgba(255, 255, 255, .8);
      }
      body.theme-dark .recent-file-item:hover .recent-file-name,
      body.theme-dark .recent-file-item.current .recent-file-name {
        color: #409eff;
      }
      body.theme-dark .recent-file-path {
        color: rgba(255, 255, 255, .4);
      }
      body.theme-dark #toc-panel {
        background: #1e1e1e;
        border-color: #363839;
      }
      body.theme-dark .toc-header {
        color: rgba(255, 255, 255, .8);
        border-bottom-color: #363839;
      }
      body.theme-dark .toc-content a {
        color: rgba(255, 255, 255, .6);
      }
      body.theme-dark .toc-content a:hover {
        color: #409eff;
        background: rgba(64, 158, 255, 0.1);
        border-left-color: #409eff;
      }
      body.theme-dark .toc-content .toc-h1 {
        color: rgba(255, 255, 255, .9);
        background: #363839;
        border-left-color: #409eff;
      }
      body.theme-dark .file-path-bar {
        background: #1e1e1e;
        border-bottom-color: #363839;
        color: rgba(255, 255, 255, .6);
      }
      body.theme-dark .file-path-bar:hover {
        background: #2a2a2a;
      }
      body.theme-dark .git-root {
        color: #409eff;
      }
      body.theme-dark .relative-path {
        color: rgba(255, 255, 255, .6);
      }
      body.theme-dark #main-content {
        background: #282828;
      }
      body.theme-dark .markdown-body {
        color: rgba(255, 255, 255, .7);
        background: #282828;
      }
      body.theme-dark .markdown-body h1,
      body.theme-dark .markdown-body h2,
      body.theme-dark .markdown-body h3,
      body.theme-dark .markdown-body h4,
      body.theme-dark .markdown-body h5,
      body.theme-dark .markdown-body h6 {
        color: rgba(255, 255, 255, .85);
        border-bottom-color: #363839;
      }
      body.theme-dark .markdown-body a {
        color: #409eff;
      }
      body.theme-dark .markdown-body code {
        background: #424344;
        color: rgba(255, 255, 255, .8);
      }
      body.theme-dark .markdown-body pre {
        background: #424344 !important;
        border: 1px solid #363839;
      }
      body.theme-dark .markdown-body pre code {
        background: transparent;
      }
      body.theme-dark .markdown-body blockquote {
        border-left-color: #409eff;
        color: rgba(255, 255, 255, .6);
      }
      body.theme-dark .markdown-body table th,
      body.theme-dark .markdown-body table td {
        border-color: #363839;
      }
      body.theme-dark .markdown-body table tr {
        background: #282828;
        border-top-color: #363839;
      }
      body.theme-dark .markdown-body table tr:nth-child(2n) {
        background: #2d2d2d;
      }
      body.theme-dark .markdown-body hr {
        background-color: #363839;
      }
      body.theme-dark .markdown-body img {
        background-color: transparent;
      }
      body.theme-dark .heading-anchor {
        color: #409eff;
      }

      /* Theme: Material Dark */
      body.theme-material-dark {
        background: #34393f;
      }
      body.theme-material-dark #sidebar {
        background: #1a2129;
        border-right-color: #4f585e;
      }
      body.theme-material-dark #sidebar h3 {
        color: rgba(255, 255, 255, 1);
      }
      body.theme-material-dark .option-label {
        color: rgba(255, 255, 255, .6);
      }
      body.theme-material-dark .option-select {
        background-color: #58606a;
        border-color: #383d44;
        color: rgba(255, 255, 255, .6);
      }
      body.theme-material-dark .option-select:focus {
        border-color: #f48237;
        box-shadow: 0 0 0 3px rgba(244, 130, 55, 0.2);
      }
      body.theme-material-dark .document-stats {
        background: #3f454c;
        border-color: #4f585e;
      }
      body.theme-material-dark .stat-row {
        border-bottom-color: #4f585e;
      }
      body.theme-material-dark .stat-label {
        color: rgba(171, 178, 191, .6);
      }
      body.theme-material-dark .stat-value {
        color: rgba(171, 178, 191, 1);
      }
      body.theme-material-dark .recent-file-item {
        background: #3f454c;
        border-color: #4f585e;
      }
      body.theme-material-dark .recent-file-item:hover {
        background: #474e56;
        border-color: #f48237;
      }
      body.theme-material-dark .recent-file-item.current {
        background: #4a4030;
        border-color: #f48237;
      }
      body.theme-material-dark .recent-file-name {
        color: rgba(255, 255, 255, .8);
      }
      body.theme-material-dark .recent-file-item:hover .recent-file-name,
      body.theme-material-dark .recent-file-item.current .recent-file-name {
        color: #f48237;
      }
      body.theme-material-dark .recent-file-path {
        color: rgba(255, 255, 255, .4);
      }
      body.theme-material-dark #toc-panel {
        background: #1a2129;
        border-color: #4f585e;
      }
      body.theme-material-dark .toc-header {
        color: rgba(255, 255, 255, 1);
        border-bottom-color: #4f585e;
      }
      body.theme-material-dark .toc-content a {
        color: rgba(171, 178, 191, .8);
      }
      body.theme-material-dark .toc-content a:hover {
        color: #f48237;
        background: rgba(244, 130, 55, 0.1);
        border-left-color: #f48237;
      }
      body.theme-material-dark .toc-content .toc-h1 {
        color: rgba(255, 255, 255, .9);
        background: #3f454c;
        border-left-color: #f48237;
      }
      body.theme-material-dark .file-path-bar {
        background: #1a2129;
        border-bottom-color: #4f585e;
        color: rgba(171, 178, 191, .8);
      }
      body.theme-material-dark .file-path-bar:hover {
        background: #252d36;
      }
      body.theme-material-dark .git-root {
        color: #f48237;
      }
      body.theme-material-dark .relative-path {
        color: rgba(171, 178, 191, .8);
      }
      body.theme-material-dark #main-content {
        background: #34393f;
      }
      body.theme-material-dark .markdown-body {
        color: rgba(171, 178, 191, .8);
        background: #34393f;
      }
      body.theme-material-dark .markdown-body h1,
      body.theme-material-dark .markdown-body h2,
      body.theme-material-dark .markdown-body h3,
      body.theme-material-dark .markdown-body h4,
      body.theme-material-dark .markdown-body h5,
      body.theme-material-dark .markdown-body h6 {
        color: rgba(255, 255, 255, .9);
        border-bottom-color: #4f585e;
      }
      body.theme-material-dark .markdown-body a {
        color: #f48237;
      }
      body.theme-material-dark .markdown-body code {
        background: #3f454c;
        color: rgba(171, 178, 191, 1);
      }
      body.theme-material-dark .markdown-body pre {
        background: #3f454c !important;
        border: 1px solid #4f585e;
      }
      body.theme-material-dark .markdown-body pre code {
        background: transparent;
      }
      body.theme-material-dark .markdown-body blockquote {
        border-left-color: #f48237;
        color: rgba(171, 178, 191, .7);
      }
      body.theme-material-dark .markdown-body table th,
      body.theme-material-dark .markdown-body table td {
        border-color: #4f585e;
      }
      body.theme-material-dark .markdown-body table tr {
        background: #34393f;
        border-top-color: #4f585e;
      }
      body.theme-material-dark .markdown-body table tr:nth-child(2n) {
        background: #3a4045;
      }
      body.theme-material-dark .markdown-body hr {
        background-color: #4f585e;
      }
      body.theme-material-dark .heading-anchor {
        color: #f48237;
      }

      /* Theme: One Dark */
      body.theme-one-dark {
        background: #282c34;
      }
      body.theme-one-dark #sidebar {
        background: #21252b;
        border-right-color: #3a3f4b;
      }
      body.theme-one-dark #sidebar h3 {
        color: #abb2bf;
      }
      body.theme-one-dark .option-label {
        color: #7f848e;
      }
      body.theme-one-dark .option-select {
        background-color: #3a3f4b;
        border-color: #4b5263;
        color: #abb2bf;
      }
      body.theme-one-dark .option-select:focus {
        border-color: #61afef;
        box-shadow: 0 0 0 3px rgba(97, 175, 239, 0.2);
      }
      body.theme-one-dark .document-stats {
        background: #3a3f4b;
        border-color: #4b5263;
      }
      body.theme-one-dark .stat-row {
        border-bottom-color: #4b5263;
      }
      body.theme-one-dark .stat-label {
        color: #7f848e;
      }
      body.theme-one-dark .stat-value {
        color: #abb2bf;
      }
      body.theme-one-dark .recent-file-item {
        background: #3a3f4b;
        border-color: #4b5263;
      }
      body.theme-one-dark .recent-file-item:hover {
        background: #4b5263;
        border-color: #61afef;
      }
      body.theme-one-dark .recent-file-item.current {
        background: #2c3e50;
        border-color: #61afef;
      }
      body.theme-one-dark .recent-file-name {
        color: #abb2bf;
      }
      body.theme-one-dark .recent-file-item:hover .recent-file-name,
      body.theme-one-dark .recent-file-item.current .recent-file-name {
        color: #61afef;
      }
      body.theme-one-dark .recent-file-path {
        color: #5c6370;
      }
      body.theme-one-dark #toc-panel {
        background: #21252b;
        border-color: #3a3f4b;
      }
      body.theme-one-dark .toc-header {
        color: #abb2bf;
        border-bottom-color: #3a3f4b;
      }
      body.theme-one-dark .toc-content a {
        color: #7f848e;
      }
      body.theme-one-dark .toc-content a:hover {
        color: #61afef;
        background: rgba(97, 175, 239, 0.1);
        border-left-color: #61afef;
      }
      body.theme-one-dark .toc-content .toc-h1 {
        color: #e5c07b;
        background: #3a3f4b;
        border-left-color: #e5c07b;
      }
      body.theme-one-dark .file-path-bar {
        background: #21252b;
        border-bottom-color: #3a3f4b;
        color: #7f848e;
      }
      body.theme-one-dark .file-path-bar:hover {
        background: #2c313a;
      }
      body.theme-one-dark .git-root {
        color: #61afef;
      }
      body.theme-one-dark .relative-path {
        color: #abb2bf;
      }
      body.theme-one-dark #main-content {
        background: #282c34;
      }
      body.theme-one-dark .markdown-body {
        color: #abb2bf;
        background: #282c34;
      }
      body.theme-one-dark .markdown-body h1,
      body.theme-one-dark .markdown-body h2 {
        color: #e5c07b;
        border-bottom-color: #3a3f4b;
      }
      body.theme-one-dark .markdown-body h3,
      body.theme-one-dark .markdown-body h4,
      body.theme-one-dark .markdown-body h5,
      body.theme-one-dark .markdown-body h6 {
        color: #c678dd;
        border-bottom-color: #3a3f4b;
      }
      body.theme-one-dark .markdown-body a {
        color: #61afef;
      }
      body.theme-one-dark .markdown-body strong {
        color: #e5c07b;
      }
      body.theme-one-dark .markdown-body code {
        background: #3a3f4b;
        color: #98c379;
      }
      body.theme-one-dark .markdown-body pre {
        background: #2c313a !important;
        border: 1px solid #3a3f4b;
      }
      body.theme-one-dark .markdown-body pre code {
        background: transparent;
        color: #abb2bf;
      }
      body.theme-one-dark .markdown-body blockquote {
        border-left-color: #e5c07b;
        color: #7f848e;
      }
      body.theme-one-dark .markdown-body table th,
      body.theme-one-dark .markdown-body table td {
        border-color: #3a3f4b;
      }
      body.theme-one-dark .markdown-body table tr {
        background: #282c34;
        border-top-color: #3a3f4b;
      }
      body.theme-one-dark .markdown-body table tr:nth-child(2n) {
        background: #2c313a;
      }
      body.theme-one-dark .markdown-body hr {
        background-color: #3a3f4b;
      }
      body.theme-one-dark .heading-anchor {
        color: #61afef;
      }

      /* Theme: Ulysses (Light) */
      body.theme-ulysses {
        background: #f3f3f3;
      }
      body.theme-ulysses #sidebar {
        background: #f8f8f8;
        border-right-color: #e5e5e5;
      }
      body.theme-ulysses #sidebar h3 {
        color: rgba(101, 101, 101, 1);
      }
      body.theme-ulysses .option-label {
        color: rgba(101, 101, 101, .6);
      }
      body.theme-ulysses .option-select {
        background-color: #ffffff;
        border-color: #dcdfe6;
        color: rgba(101, 101, 101, .7);
      }
      body.theme-ulysses .option-select:focus {
        border-color: rgb(12, 139, 186);
        box-shadow: 0 0 0 3px rgba(12, 139, 186, 0.1);
      }
      body.theme-ulysses .document-stats {
        background: #ffffff;
        border-color: #e5e5e5;
      }
      body.theme-ulysses .stat-row {
        border-bottom-color: #eeeeee;
      }
      body.theme-ulysses .stat-label {
        color: rgba(101, 101, 101, .6);
      }
      body.theme-ulysses .stat-value {
        color: rgba(101, 101, 101, .9);
      }
      body.theme-ulysses .recent-file-item {
        background: #ffffff;
        border-color: #e5e5e5;
      }
      body.theme-ulysses .recent-file-item:hover {
        background: #f0f8ff;
        border-color: rgb(12, 139, 186);
      }
      body.theme-ulysses .recent-file-item.current {
        background: #e8f4f8;
        border-color: rgb(12, 139, 186);
      }
      body.theme-ulysses .recent-file-name {
        color: rgba(101, 101, 101, .9);
      }
      body.theme-ulysses .recent-file-item:hover .recent-file-name,
      body.theme-ulysses .recent-file-item.current .recent-file-name {
        color: rgb(12, 139, 186);
      }
      body.theme-ulysses .recent-file-path {
        color: rgba(101, 101, 101, .4);
      }
      body.theme-ulysses #toc-panel {
        background: #f8f8f8;
        border-color: #e5e5e5;
      }
      body.theme-ulysses .toc-header {
        color: rgba(101, 101, 101, 1);
        border-bottom-color: #e5e5e5;
      }
      body.theme-ulysses .toc-content a {
        color: rgba(101, 101, 101, .7);
      }
      body.theme-ulysses .toc-content a:hover {
        color: rgb(12, 139, 186);
        background: rgba(12, 139, 186, 0.05);
        border-left-color: rgb(12, 139, 186);
      }
      body.theme-ulysses .toc-content .toc-h1 {
        color: rgb(12, 139, 186);
        background: rgba(12, 139, 186, 0.08);
        border-left-color: rgb(12, 139, 186);
      }
      body.theme-ulysses .file-path-bar {
        background: #f8f8f8;
        border-bottom-color: #e5e5e5;
        color: rgba(101, 101, 101, .7);
      }
      body.theme-ulysses .file-path-bar:hover {
        background: #f0f0f0;
      }
      body.theme-ulysses .git-root {
        color: rgb(12, 139, 186);
      }
      body.theme-ulysses .relative-path {
        color: rgba(101, 101, 101, .7);
      }
      body.theme-ulysses #main-content {
        background: #f3f3f3;
      }
      body.theme-ulysses .markdown-body {
        color: rgba(101, 101, 101, .7);
        background: #f3f3f3;
      }
      body.theme-ulysses .markdown-body h1,
      body.theme-ulysses .markdown-body h2,
      body.theme-ulysses .markdown-body h3,
      body.theme-ulysses .markdown-body h4,
      body.theme-ulysses .markdown-body h5,
      body.theme-ulysses .markdown-body h6 {
        color: rgb(12, 139, 186);
        border-bottom-color: #e5e5e5;
      }
      body.theme-ulysses .markdown-body a {
        color: rgb(12, 139, 186);
      }
      body.theme-ulysses .markdown-body code {
        background: rgba(12, 139, 186, 0.08);
        color: rgba(101, 101, 101, .9);
      }
      body.theme-ulysses .markdown-body pre {
        background: rgba(12, 139, 186, 0.05) !important;
        border: 1px solid #e5e5e5;
      }
      body.theme-ulysses .markdown-body pre code {
        background: transparent;
      }
      body.theme-ulysses .markdown-body blockquote {
        border-left-color: rgb(12, 139, 186);
        background: rgb(233, 233, 233);
        color: rgba(101, 101, 101, .7);
      }
      body.theme-ulysses .markdown-body table th,
      body.theme-ulysses .markdown-body table td {
        border-color: #e5e5e5;
      }
      body.theme-ulysses .markdown-body table tr {
        background: #f3f3f3;
        border-top-color: #e5e5e5;
      }
      body.theme-ulysses .markdown-body table tr:nth-child(2n) {
        background: #eeeeee;
      }
      body.theme-ulysses .markdown-body hr {
        background-color: #e5e5e5;
      }
      body.theme-ulysses .heading-anchor {
        color: rgb(12, 139, 186);
      }

      /* Theme: GitHub Dark (explicit dark mode) */
      body.theme-github-dark {
        background: #0d1117;
      }
      body.theme-github-dark #sidebar {
        background: #161b22;
        border-right-color: #30363d;
      }
      body.theme-github-dark #sidebar h3 {
        color: #c9d1d9;
      }
      body.theme-github-dark .option-label {
        color: #8b949e;
      }
      body.theme-github-dark .option-select {
        background-color: #0d1117;
        border-color: #30363d;
        color: #c9d1d9;
      }
      body.theme-github-dark .option-select:hover {
        border-color: #6e7681;
      }
      body.theme-github-dark .option-select:focus {
        border-color: #58a6ff;
        box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.1);
      }
      body.theme-github-dark .document-stats {
        background: #0d1117;
        border-color: #30363d;
      }
      body.theme-github-dark .stat-row {
        border-bottom-color: #21262d;
      }
      body.theme-github-dark .stat-label {
        color: #8b949e;
      }
      body.theme-github-dark .stat-value {
        color: #c9d1d9;
      }
      body.theme-github-dark .recent-file-item {
        background: #0d1117;
        border-color: #30363d;
      }
      body.theme-github-dark .recent-file-item:hover {
        background: #1c2128;
        border-color: #58a6ff;
      }
      body.theme-github-dark .recent-file-item.current {
        background: #1c2d41;
        border-color: #58a6ff;
      }
      body.theme-github-dark .recent-file-name {
        color: #c9d1d9;
      }
      body.theme-github-dark .recent-file-item:hover .recent-file-name,
      body.theme-github-dark .recent-file-item.current .recent-file-name {
        color: #58a6ff;
      }
      body.theme-github-dark .recent-file-path {
        color: #6e7781;
      }
      body.theme-github-dark .recent-file-item:hover .recent-file-path {
        color: #8b949e;
      }
      body.theme-github-dark .markdown-body.show-line-numbers > *::before,
      body.theme-github-dark .markdown-body.show-line-numbers-both > *::before {
        color: #6e7681;
      }
      body.theme-github-dark #toc-panel {
        background: #161b22;
        border-color: #30363d;
      }
      body.theme-github-dark .toc-header {
        color: #c9d1d9;
        border-bottom-color: #30363d;
      }
      body.theme-github-dark .toc-content a {
        color: #8b949e;
      }
      body.theme-github-dark .toc-content a:hover {
        color: #58a6ff;
        background: #1c2128;
        border-left-color: #58a6ff;
      }
      body.theme-github-dark .toc-content .toc-h1 {
        color: #c9d1d9;
        background: #21262d;
        border-left-color: #58a6ff;
      }
      body.theme-github-dark .toc-content .toc-h1:hover {
        background: #2d333b;
      }
      body.theme-github-dark .toc-content .toc-h2 {
        color: #c9d1d9;
      }
      body.theme-github-dark .toc-resize-handle:hover,
      body.theme-github-dark .toc-resize-handle.resizing {
        background: #58a6ff;
      }
      body.theme-github-dark .file-path-bar {
        background: #161b22;
        border-bottom-color: #30363d;
        color: #8b949e;
      }
      body.theme-github-dark .file-path-bar:hover {
        background: #1c2128;
      }
      body.theme-github-dark .file-path-bar:active {
        background: #21262d;
      }
      body.theme-github-dark .git-root {
        color: #58a6ff;
      }
      body.theme-github-dark .file-path-bar:hover .git-root {
        color: #79c0ff;
      }
      body.theme-github-dark .relative-path {
        color: #8b949e;
      }
      body.theme-github-dark .file-path-bar:hover .relative-path {
        color: #c9d1d9;
      }
      body.theme-github-dark .path-separator {
        color: #6e7681;
      }
      body.theme-github-dark .toast {
        background: #58a6ff;
        color: #0d1117;
        box-shadow: 0 8px 24px rgba(88, 166, 255, 0.5);
      }
      body.theme-github-dark #main-content {
        background: #0d1117;
      }
      body.theme-github-dark .markdown-body {
        color-scheme: dark;
        --color-prettylights-syntax-comment: #8b949e;
        --color-prettylights-syntax-constant: #79c0ff;
        --color-prettylights-syntax-entity: #d2a8ff;
        --color-prettylights-syntax-storage-modifier-import: #c9d1d9;
        --color-prettylights-syntax-entity-tag: #7ee787;
        --color-prettylights-syntax-keyword: #ff7b72;
        --color-prettylights-syntax-string: #a5d6ff;
        --color-prettylights-syntax-variable: #ffa657;
        --color-prettylights-syntax-brackethighlighter-unmatched: #f85149;
        --color-prettylights-syntax-invalid-illegal-text: #f0f6fc;
        --color-prettylights-syntax-invalid-illegal-bg: #8e1519;
        --color-prettylights-syntax-carriage-return-text: #f0f6fc;
        --color-prettylights-syntax-carriage-return-bg: #b62324;
        --color-prettylights-syntax-string-regexp: #7ee787;
        --color-prettylights-syntax-markup-list: #f2cc60;
        --color-prettylights-syntax-markup-heading: #1f6feb;
        --color-prettylights-syntax-markup-italic: #c9d1d9;
        --color-prettylights-syntax-markup-bold: #c9d1d9;
        --color-prettylights-syntax-markup-deleted-text: #ffdcd7;
        --color-prettylights-syntax-markup-deleted-bg: #67060c;
        --color-prettylights-syntax-markup-inserted-text: #aff5b4;
        --color-prettylights-syntax-markup-inserted-bg: #033a16;
        --color-prettylights-syntax-markup-changed-text: #ffdfb6;
        --color-prettylights-syntax-markup-changed-bg: #5a1e02;
        --color-prettylights-syntax-markup-ignored-text: #c9d1d9;
        --color-prettylights-syntax-markup-ignored-bg: #1158c7;
        --color-prettylights-syntax-meta-diff-range: #d2a8ff;
        --color-prettylights-syntax-brackethighlighter-angle: #8b949e;
        --color-prettylights-syntax-sublimelinter-gutter-mark: #484f58;
        --color-prettylights-syntax-constant-other-reference-link: #a5d6ff;
        --color-fg-default: #c9d1d9;
        --color-fg-muted: #8b949e;
        --color-fg-subtle: #6e7681;
        --color-canvas-default: #0d1117;
        --color-canvas-subtle: #161b22;
        --color-border-default: #30363d;
        --color-border-muted: #21262d;
        --color-neutral-muted: rgba(110,118,129,0.4);
        --color-accent-fg: #58a6ff;
        --color-accent-emphasis: #1f6feb;
        --color-attention-subtle: rgba(187,128,9,0.15);
        --color-danger-fg: #f85149;
        background-color: #0d1117;
        color: #c9d1d9;
      }
      body.theme-github-dark .markdown-body a {
        color: #58a6ff;
      }
      body.theme-github-dark .markdown-body h1,
      body.theme-github-dark .markdown-body h2 {
        border-bottom-color: #21262d;
      }
      body.theme-github-dark .markdown-body hr {
        background-color: #21262d;
      }
      body.theme-github-dark .markdown-body table tr {
        background-color: #0d1117;
        border-top-color: #21262d;
      }
      body.theme-github-dark .markdown-body table tr:nth-child(2n) {
        background-color: #161b22;
      }
      body.theme-github-dark .markdown-body table th,
      body.theme-github-dark .markdown-body table td {
        border-color: #30363d;
      }
      body.theme-github-dark .markdown-body blockquote {
        border-left-color: #30363d;
        color: #8b949e;
      }
      body.theme-github-dark .markdown-body code {
        background-color: rgba(110,118,129,0.4);
      }
      body.theme-github-dark .markdown-body pre {
        background-color: #161b22;
      }
      body.theme-github-dark .markdown-body pre code {
        background-color: transparent;
      }
      body.theme-github-dark .heading-anchor {
        color: #58a6ff;
      }

    </style>
    <title>Markdown Preview</title>
</head>
<body>
    <div id="sidebar">
        <div class="sidebar-section">
            <h3>Recent Previews</h3>
            <div id="recent-files" class="recent-files"></div>
        </div>
        <div class="sidebar-section">
            <h3>Display Options</h3>
            <div class="option-group">
                <label class="option-label">Line Numbers</label>
                <select id="line-numbers-mode" class="option-select">
                    <option value="off">Off</option>
                    <option value="rendered">Rendered Elements (1, 2, 3...)</option>
                    <option value="source">Source File (Git-style)</option>
                    <option value="both">Both (Rendered / Source)</option>
                </select>
            </div>
            <div class="option-group">
                <label class="option-label">Table of Contents</label>
                <select id="toc-mode" class="option-select">
                    <option value="off">Off</option>
                    <option value="left">Show (Left)</option>
                    <option value="right">Show (Right)</option>
                </select>
            </div>
            <div class="option-group">
                <label class="option-label">Font Family</label>
                <select id="font-family" class="option-select">
                    <option value="default">GitHub (Default)</option>
                    <option value="inter">Inter</option>
                    <option value="merriweather">Merriweather</option>
                    <option value="ibm-plex">IBM Plex Sans</option>
                    <option value="literata">Literata</option>
                    <option value="serif">Serif (LaTeX-like)</option>
                    <option value="mono">Monospace</option>
                    <option value="system">System UI</option>
                </select>
            </div>
            <div class="option-group">
                <label class="option-label">Theme</label>
                <select id="theme-select" class="option-select">
                    <option value="auto">Auto (System)</option>
                    <option value="github-light">GitHub Light</option>
                    <option value="github-dark">GitHub Dark</option>
                    <option value="dark">Dark</option>
                    <option value="material-dark">Material Dark</option>
                    <option value="one-dark">One Dark</option>
                    <option value="ulysses">Ulysses Light</option>
                </select>
            </div>
            <div class="option-group">
                <label class="option-label">Reading Mode</label>
                <select id="reader-mode" class="option-select">
                    <option value="off">Normal</option>
                    <option value="on">Reader Mode</option>
                </select>
            </div>
            <div class="option-group">
                <label class="option-label">Zoom</label>
                <div class="zoom-controls">
                    <button id="zoom-out-btn" class="zoom-btn" title="Zoom Out (Ctrl+-)"></button>
                    <span id="zoom-level-display" class="zoom-display">100%</span>
                    <button id="zoom-in-btn" class="zoom-btn" title="Zoom In (Ctrl++)">+</button>
                    <button id="zoom-reset-btn" class="zoom-btn zoom-reset" title="Reset Zoom (Ctrl+0)">Reset</button>
                </div>
            </div>
        </div>
        <div class="sidebar-section">
            <h3>Document Stats</h3>
            <div id="document-stats" class="document-stats">
                <div class="stat-row">
                    <span class="stat-label">Words</span>
                    <span class="stat-value" id="stat-words">-</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Characters</span>
                    <span class="stat-value" id="stat-characters">-</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Lines</span>
                    <span class="stat-value" id="stat-lines">-</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Reading time</span>
                    <span class="stat-value" id="stat-reading-time">-</span>
                </div>
            </div>
        </div>
    </div>

    <div id="toc-panel" class="toc-panel">
        <div class="toc-header">Table of Contents</div>
        <nav id="toc-content" class="toc-content"></nav>
        <div class="toc-resize-handle"></div>
    </div>

    <div id="main-content">
        <div class="file-path-bar" id="file-path-bar" title="Click to copy path"></div>
        <article class="markdown-body" id="content">
            <!-- Welcome screen - shown when no file is open, replaced when content loads -->
            <div id="welcome-screen" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 70vh; color: #666; text-align: center;">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin-bottom: 20px; opacity: 0.5;">
                    <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <path d="M12 18v-6"></path>
                    <path d="M9 15h6"></path>
                </svg>
                <h2 style="margin: 0 0 10px 0; font-weight: 500; color: #333;">Markdown Preview</h2>
                <p style="margin: 0 0 24px 0; font-size: 14px;">Open a markdown file to preview</p>
                <button id="welcome-open-btn" style="
                    padding: 12px 24px;
                    font-size: 15px;
                    background: #0969da;
                    color: white;
                    border: none;
                    border-radius: 6px;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                " onmouseover="this.style.background='#0860ca'" onmouseout="this.style.background='#0969da'">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M5 19a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h4l2 2h9a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H5z"></path>
                    </svg>
                    Open File
                </button>
                <p style="margin-top: 16px; font-size: 12px; color: #888;">
                    Or press <kbd style="background: #eee; padding: 2px 6px; border-radius: 3px; font-family: monospace;">O</kbd>  Drag &amp; drop  Use File menu
                </p>
            </div>
        </article>
    </div>

    <script>
// Markdown Preview Core - Shared UI functionality
// This module contains all UI-related functions shared between vim-clap (WebSocket) and Tauri modes

// ============================================================================
// State Variables
// ============================================================================

let currentSourceLines = 0;
let currentLineMap = [];
let tocVisible = false;
let fontFamily = 'default';
let readerMode = false;
let currentFilePath = '';
let currentTheme = 'auto';
let lineNumberMode = 'off';
let zoomLevel = 100; // Percentage: 50-200

// Fuzzy finder state
let fuzzyFinderOpen = false;
let fuzzySearchMode = 'headings';
let fuzzySelectedIndex = 0;
let fuzzyResults = [];
let fuzzySearchIndex = { headings: [], text: [] };

// ============================================================================
// Utility Functions
// ============================================================================

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatNumber(num) {
    return num.toLocaleString();
}

function formatReadingTime(minutes) {
    if (minutes < 1) {
        return '< 1 min';
    } else if (minutes === 1) {
        return '1 min';
    } else if (minutes < 60) {
        return minutes + ' min';
    } else {
        const hours = Math.floor(minutes / 60);
        const remainingMinutes = minutes % 60;
        if (remainingMinutes === 0) {
            return hours + (hours === 1 ? ' hour' : ' hours');
        }
        return hours + (hours === 1 ? ' hour ' : ' hours ') + remainingMinutes + ' min';
    }
}

function getFileBasename(path) {
    if (!path) return '';
    const parts = path.split('/');
    return parts[parts.length - 1];
}

function getFileDirectory(path) {
    if (!path) return '';
    const parts = path.split('/');
    if (parts.length <= 1) return '';
    return parts.slice(0, -1).join('/');
}

// ============================================================================
// Toast Notifications
// ============================================================================

function showToast(message, subtitle = null, duration = 2000) {
    const toast = document.createElement('div');
    toast.className = 'toast';

    if (subtitle) {
        const titleDiv = document.createElement('div');
        titleDiv.className = 'toast-title';
        titleDiv.textContent = message;
        toast.appendChild(titleDiv);

        const pathDiv = document.createElement('div');
        pathDiv.className = 'toast-path';
        pathDiv.textContent = subtitle;
        toast.appendChild(pathDiv);
    } else {
        toast.textContent = message;
    }

    document.body.appendChild(toast);

    setTimeout(() => {
        toast.classList.add('show');
    }, 10);

    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
            document.body.removeChild(toast);
        }, 300);
    }, duration);
}

async function copyToClipboard(text) {
    // Try Tauri clipboard API first (multiple possible paths in Tauri 2.x)
    if (window.__TAURI__) {
        const clipboardApi = window.__TAURI__.clipboard
            || window.__TAURI__.clipboardManager
            || window.__TAURI__.plugin?.clipboardManager;

        if (clipboardApi && clipboardApi.writeText) {
            try {
                await clipboardApi.writeText(text);
                console.log('Copied to clipboard (Tauri):', text);
                showToast('Copied: ' + getFileBasename(text), text);
                return;
            } catch (err) {
                console.error('Failed to copy via Tauri clipboard:', err);
                // Fall through to browser API
            }
        } else {
            console.log('Tauri clipboard API not found, available:', Object.keys(window.__TAURI__));
        }
    }

    // Fall back to browser clipboard API
    if (navigator.clipboard && navigator.clipboard.writeText) {
        try {
            await navigator.clipboard.writeText(text);
            console.log('Copied to clipboard (browser):', text);
            showToast('Copied: ' + getFileBasename(text), text);
            return;
        } catch (err) {
            console.error('Failed to copy via browser clipboard:', err);
            // Fall through to legacy method
        }
    }

    // Legacy fallback using execCommand
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.left = '-999999px';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    try {
        document.execCommand('copy');
        console.log('Copied to clipboard (legacy):', text);
        showToast('Copied: ' + getFileBasename(text), text);
    } catch (err) {
        console.error('Failed to copy to clipboard (legacy):', err);
        showToast('Failed to copy to clipboard');
    }
    document.body.removeChild(textArea);
}

// ============================================================================
// Code Highlighting & Rendering
// ============================================================================

function codeHighlight() {
    if (typeof hljs !== 'undefined') {
        document.querySelectorAll('pre code').forEach((el) => {
            hljs.highlightElement(el);
        });
    }
}

async function renderMermaid() {
    if (window.mermaid !== undefined) {
        await window.mermaid.run({
            querySelector: '.language-mermaid'
        });
    }
}

function renderLatex() {
    if (typeof renderMathInElement !== 'undefined') {
        renderMathInElement(document.getElementById('content'), {
            delimiters: [
                {left: "$$", right: "$$", display: true},
                {left: "$", right: "$", display: false}
            ]
        });
    }
}

// ============================================================================
// Line Numbers
// ============================================================================

function applyLineNumberMode(mode, sourceLines, lineMap) {
    const content = document.getElementById('content');
    if (!content) return;

    if (sourceLines) {
        currentSourceLines = sourceLines;
    }
    if (lineMap) {
        currentLineMap = lineMap;
    }

    content.classList.remove('show-line-numbers', 'show-line-numbers-both');
    const children = Array.from(content.children);
    children.forEach((child) => {
        child.removeAttribute('data-line-number');
        child.removeAttribute('data-source-line');
        child.removeAttribute('data-rendered-number');
        child.removeAttribute('data-source-number');
    });

    if (mode === 'off') {
        return;
    }

    if (mode === 'rendered') {
        content.classList.add('show-line-numbers');
        children.forEach((child, index) => {
            const renderedNum = index + 1;
            child.setAttribute('data-line-number', renderedNum);
            const sourceNum = currentLineMap[index] || renderedNum;
            child.setAttribute('data-source-line', sourceNum);
        });
    } else if (mode === 'source') {
        content.classList.add('show-line-numbers');
        children.forEach((child, index) => {
            const sourceNum = currentLineMap[index] || Math.min(
                Math.floor((index / Math.max(1, children.length)) * currentSourceLines) + 1,
                currentSourceLines
            );
            child.setAttribute('data-line-number', sourceNum);
            child.setAttribute('data-source-line', sourceNum);
        });
    } else if (mode === 'both') {
        content.classList.add('show-line-numbers-both');
        children.forEach((child, index) => {
            const renderedNum = index + 1;
            const sourceNum = currentLineMap[index] || Math.min(
                Math.floor((index / Math.max(1, children.length)) * currentSourceLines) + 1,
                currentSourceLines
            );
            child.setAttribute('data-rendered-number', renderedNum);
            child.setAttribute('data-source-number', sourceNum);
            child.setAttribute('data-source-line', sourceNum);
        });
    }
}

function changeLineNumberMode(newMode) {
    lineNumberMode = newMode;
    applyLineNumberMode(lineNumberMode, currentSourceLines, currentLineMap);
    localStorage.setItem('lineNumberMode', lineNumberMode);
}

// ============================================================================
// Zoom
// ============================================================================

const ZOOM_MIN = 50;
const ZOOM_MAX = 200;
const ZOOM_STEP = 10;

function applyZoom(level) {
    const content = document.getElementById('content');
    if (!content) return;

    zoomLevel = Math.max(ZOOM_MIN, Math.min(ZOOM_MAX, level));
    content.style.fontSize = `${zoomLevel}%`;
    localStorage.setItem('zoomLevel', zoomLevel);
    updateZoomDisplay();
}

function updateZoomDisplay() {
    const display = document.getElementById('zoom-level-display');
    if (display) {
        display.textContent = `${zoomLevel}%`;
    }
}

function zoomIn() {
    applyZoom(zoomLevel + ZOOM_STEP);
    showToast(`Zoom: ${zoomLevel}%`);
}

function zoomOut() {
    applyZoom(zoomLevel - ZOOM_STEP);
    showToast(`Zoom: ${zoomLevel}%`);
}

function resetZoom() {
    applyZoom(100);
    showToast('Zoom reset to 100%');
}

// ============================================================================
// Navigation
// ============================================================================

function scrollToSourceLine(lineNumber) {
    const content = document.getElementById('content');
    if (!content) return;

    const children = Array.from(content.children);
    let closestElement = null;
    let closestDiff = Infinity;

    children.forEach((child) => {
        const sourceLine = parseInt(child.getAttribute('data-source-line') || '0');
        const diff = Math.abs(sourceLine - lineNumber);
        if (diff < closestDiff) {
            closestDiff = diff;
            closestElement = child;
        }
    });

    if (closestElement) {
        closestElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
        closestElement.style.backgroundColor = '#ffeb3b';
        setTimeout(() => {
            closestElement.style.backgroundColor = '';
        }, 1000);
    }
}

function navigateToHeading(id, smooth = true) {
    const heading = document.getElementById(id);
    if (heading) {
        history.pushState(null, '', `#${id}`);
        heading.scrollIntoView({ behavior: smooth ? 'smooth' : 'auto', block: 'start' });
    }
}

function scrollToHash() {
    const hash = window.location.hash.slice(1);
    if (hash) {
        setTimeout(() => {
            const element = document.getElementById(hash);
            if (element) {
                element.scrollIntoView({ behavior: 'auto', block: 'start' });
            }
        }, 100);
    }
}

// ============================================================================
// Heading Anchors
// ============================================================================

function addHeadingAnchors() {
    const content = document.getElementById('content');
    if (!content) return;

    const headings = content.querySelectorAll('h1, h2, h3, h4, h5, h6');

    headings.forEach((heading, index) => {
        if (!heading.id) {
            heading.id = `heading-${index}`;
        }

        if (heading.querySelector('.heading-anchor')) return;

        heading.style.display = 'flex';
        heading.style.alignItems = 'center';
        heading.style.flexWrap = 'wrap';

        const anchor = document.createElement('a');
        anchor.className = 'heading-anchor';
        anchor.href = `#${heading.id}`;
        anchor.setAttribute('aria-label', `Link to ${heading.textContent}`);
        anchor.innerHTML = '<svg class="octicon" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg>';

        anchor.onclick = (e) => {
            e.preventDefault();
            navigateToHeading(heading.id);
        };

        heading.insertBefore(anchor, heading.firstChild);
    });
}

// ============================================================================
// Table of Contents
// ============================================================================

function generateTOC() {
    const content = document.getElementById('content');
    const tocContent = document.getElementById('toc-content');
    if (!content || !tocContent) return;

    const headings = content.querySelectorAll('h1, h2, h3, h4, h5, h6');
    tocContent.innerHTML = '';

    headings.forEach((heading, index) => {
        const level = heading.tagName.toLowerCase();
        const textNode = Array.from(heading.childNodes).find(n => n.nodeType === Node.TEXT_NODE || (n.nodeType === Node.ELEMENT_NODE && !n.classList.contains('heading-anchor')));
        const text = textNode ? textNode.textContent : heading.textContent;
        const id = heading.id || `heading-${index}`;

        if (!heading.id) {
            heading.id = id;
        }

        const link = document.createElement('a');
        link.href = `#${id}`;
        link.textContent = text.trim();
        link.className = `toc-${level}`;
        link.onclick = (e) => {
            e.preventDefault();
            navigateToHeading(id);
        };

        tocContent.appendChild(link);
    });
}

function getDefaultTOCWidth() {
    const screenWidth = window.innerWidth;
    if (screenWidth >= 1920) {
        return 350;
    } else if (screenWidth >= 1440) {
        return 300;
    } else {
        return 250;
    }
}

function toggleTOC(mode) {
    const tocPanel = document.getElementById('toc-panel');

    if (mode === 'off') {
        tocVisible = false;
        tocPanel.classList.remove('visible', 'toc-left', 'toc-right');
    } else {
        tocVisible = true;
        tocPanel.classList.add('visible');

        if (mode === 'left') {
            tocPanel.classList.remove('toc-right');
            tocPanel.classList.add('toc-left');
        } else if (mode === 'right') {
            tocPanel.classList.remove('toc-left');
            tocPanel.classList.add('toc-right');
        }

        generateTOC();

        const savedWidth = localStorage.getItem('tocWidth');
        if (savedWidth) {
            tocPanel.style.width = savedWidth + 'px';
        } else {
            const defaultWidth = getDefaultTOCWidth();
            tocPanel.style.width = defaultWidth + 'px';
        }
    }

    localStorage.setItem('tocMode', mode);
}

function setupTOCResize() {
    const tocPanel = document.getElementById('toc-panel');
    const resizeHandle = document.querySelector('.toc-resize-handle');
    let isResizing = false;
    let startX = 0;
    let startWidth = 0;

    resizeHandle.addEventListener('mousedown', (e) => {
        isResizing = true;
        startX = e.clientX;
        startWidth = tocPanel.offsetWidth;
        resizeHandle.classList.add('resizing');
        document.body.style.cursor = 'col-resize';
        document.body.style.userSelect = 'none';
        e.preventDefault();
    });

    document.addEventListener('mousemove', (e) => {
        if (!isResizing) return;

        const delta = e.clientX - startX;
        const isRightSide = tocPanel.classList.contains('toc-right');
        const newWidth = isRightSide ? startWidth - delta : startWidth + delta;
        const minWidth = 150;
        const maxWidth = 500;

        if (newWidth >= minWidth && newWidth <= maxWidth) {
            tocPanel.style.width = newWidth + 'px';
        }
    });

    document.addEventListener('mouseup', () => {
        if (isResizing) {
            isResizing = false;
            resizeHandle.classList.remove('resizing');
            document.body.style.cursor = '';
            document.body.style.userSelect = '';
            localStorage.setItem('tocWidth', tocPanel.offsetWidth);
        }
    });
}

// ============================================================================
// Theme & Font
// ============================================================================

function changeFontFamily(family) {
    fontFamily = family;
    const content = document.getElementById('content');
    if (!content) return;

    content.classList.remove('font-serif', 'font-mono', 'font-system', 'font-inter', 'font-merriweather', 'font-ibm-plex', 'font-literata');

    if (family !== 'default') {
        content.classList.add('font-' + family);
    }

    localStorage.setItem('fontFamily', family);
}

function toggleReaderMode(enabled) {
    readerMode = enabled;
    const content = document.getElementById('content');
    if (!content) return;

    if (enabled) {
        content.classList.add('reader-mode');
    } else {
        content.classList.remove('reader-mode');
    }

    localStorage.setItem('readerMode', enabled);
}

function changeTheme(theme) {
    currentTheme = theme;

    document.body.classList.remove(
        'theme-dark',
        'theme-material-dark',
        'theme-one-dark',
        'theme-ulysses',
        'theme-github-light',
        'theme-github-dark'
    );

    if (theme === 'auto') {
        // Use system preference
    } else if (theme === 'github-light') {
        // Default light theme
    } else if (theme === 'github-dark') {
        document.body.classList.add('theme-github-dark');
    } else if (theme === 'dark') {
        document.body.classList.add('theme-dark');
    } else if (theme === 'material-dark') {
        document.body.classList.add('theme-material-dark');
    } else if (theme === 'one-dark') {
        document.body.classList.add('theme-one-dark');
    } else if (theme === 'ulysses') {
        document.body.classList.add('theme-ulysses');
    }

    localStorage.setItem('theme', theme);
}

// ============================================================================
// Recent Files (localStorage-based)
// ============================================================================

function getRecentFiles() {
    const recent = localStorage.getItem('recentFiles');
    return recent ? JSON.parse(recent) : [];
}

function addToRecentFiles(filePath) {
    if (!filePath) return;

    let recentFiles = getRecentFiles();
    recentFiles = recentFiles.filter(f => f.path !== filePath);
    recentFiles.unshift({
        path: filePath,
        timestamp: Date.now()
    });
    recentFiles = recentFiles.slice(0, 10);
    localStorage.setItem('recentFiles', JSON.stringify(recentFiles));
}

// Custom tooltip for recent files
let pathTooltip = null;
let tooltipTimeout = null;

function createPathTooltip() {
    if (pathTooltip) return pathTooltip;

    pathTooltip = document.createElement('div');
    pathTooltip.className = 'path-tooltip';
    pathTooltip.innerHTML = '<div class="path-tooltip-content"></div>';
    document.body.appendChild(pathTooltip);

    return pathTooltip;
}

function showPathTooltip(element, fullPath) {
    const tooltip = createPathTooltip();
    const content = tooltip.querySelector('.path-tooltip-content');

    // Format path with segments
    const segments = fullPath.split('/').filter(s => s);
    const formatted = '/' + segments.map((seg, i) => {
        const isLast = i === segments.length - 1;
        return isLast ? `<span class="path-tooltip-file">${seg}</span>` : seg;
    }).join('<span class="path-tooltip-sep">/</span>');

    content.innerHTML = formatted;

    // Position tooltip to the right of the element
    const rect = element.getBoundingClientRect();
    tooltip.style.left = `${rect.right + 8}px`;
    tooltip.style.top = `${rect.top}px`;
    tooltip.classList.add('visible');
}

function hidePathTooltip() {
    if (pathTooltip) {
        pathTooltip.classList.remove('visible');
    }
}

function renderRecentFiles(onFileClick) {
    const container = document.getElementById('recent-files');
    if (!container) return;

    const recentFiles = getRecentFiles();

    if (recentFiles.length === 0) {
        container.innerHTML = '<div class="no-recent-files">No recent files</div>';
        return;
    }

    container.innerHTML = '';
    recentFiles.forEach(file => {
        const item = document.createElement('div');
        item.className = 'recent-file-item';
        if (file.path === currentFilePath) {
            item.classList.add('current');
        }

        const nameElement = document.createElement('div');
        nameElement.className = 'recent-file-name';
        nameElement.textContent = getFileBasename(file.path);

        const pathElement = document.createElement('div');
        pathElement.className = 'recent-file-path';
        pathElement.textContent = getFileDirectory(file.path);

        item.appendChild(nameElement);
        item.appendChild(pathElement);

        // Custom tooltip on hover
        item.addEventListener('mouseenter', () => {
            if (tooltipTimeout) clearTimeout(tooltipTimeout);
            tooltipTimeout = setTimeout(() => {
                showPathTooltip(item, file.path);
            }, 400);
        });

        item.addEventListener('mouseleave', () => {
            if (tooltipTimeout) {
                clearTimeout(tooltipTimeout);
                tooltipTimeout = null;
            }
            hidePathTooltip();
        });

        item.onclick = (e) => {
            if (e.shiftKey) {
                copyToClipboard(file.path);
                e.stopPropagation();
                return;
            }
            if (onFileClick) {
                onFileClick(file.path);
            }
        };

        item.oncontextmenu = (e) => {
            e.preventDefault();
            copyToClipboard(file.path);
        };

        container.appendChild(item);
    });
}

// ============================================================================
// File Path Bar
// ============================================================================

function updateFilePathBar(filePath, gitRoot) {
    const pathBar = document.getElementById('file-path-bar');
    if (!pathBar) return;

    if (filePath) {
        pathBar.style.display = 'block';
        pathBar.title = `Click to copy: ${filePath}`;

        if (gitRoot && filePath.startsWith(gitRoot)) {
            const gitRootName = gitRoot.split('/').filter(p => p).pop() || gitRoot;
            const relativePath = filePath.substring(gitRoot.length);
            pathBar.innerHTML = `<span class="git-root">${gitRootName}</span><span class="path-separator">/</span><span class="relative-path">${relativePath.replace(/^\//, '')}</span>`;
        } else {
            pathBar.textContent = filePath;
        }
    } else {
        pathBar.style.display = 'none';
    }
}

// ============================================================================
// Document Stats
// ============================================================================

function updateDocumentStats(stats) {
    if (!stats) return;

    const wordsEl = document.getElementById('stat-words');
    const charsEl = document.getElementById('stat-characters');
    const linesEl = document.getElementById('stat-lines');
    const timeEl = document.getElementById('stat-reading-time');

    if (wordsEl) wordsEl.textContent = formatNumber(stats.words);
    if (charsEl) charsEl.textContent = formatNumber(stats.characters);
    if (linesEl) linesEl.textContent = formatNumber(stats.lines);
    if (timeEl) timeEl.textContent = formatReadingTime(stats.reading_minutes || stats.reading_time_minutes);
}

// ============================================================================
// Fuzzy Finder
// ============================================================================

function fuzzyMatch(pattern, text) {
    if (!pattern) return { score: 0, positions: [] };

    const patternLower = pattern.toLowerCase();
    const textLower = text.toLowerCase();

    let patternIdx = 0;
    let score = 0;
    let positions = [];
    let lastMatchIdx = -1;

    for (let i = 0; i < text.length && patternIdx < pattern.length; i++) {
        if (textLower[i] === patternLower[patternIdx]) {
            positions.push(i);

            if (lastMatchIdx === i - 1) {
                score += 10;
            }

            if (i === 0 || /[\s\-_./]/.test(text[i - 1])) {
                score += 5;
            }

            if (text[i] === pattern[patternIdx]) {
                score += 2;
            }

            score += 1;
            lastMatchIdx = i;
            patternIdx++;
        }
    }

    if (patternIdx !== pattern.length) {
        return { score: 0, positions: [] };
    }

    score += Math.max(0, 50 - text.length);

    return { score, positions };
}

function highlightMatches(text, positions) {
    if (!positions.length) return escapeHtml(text);

    let result = '';
    let lastIdx = 0;

    for (const pos of positions) {
        result += escapeHtml(text.slice(lastIdx, pos));
        result += `<span class="fuzzy-match">${escapeHtml(text[pos])}</span>`;
        lastIdx = pos + 1;
    }
    result += escapeHtml(text.slice(lastIdx));

    return result;
}

function buildFuzzyIndex() {
    const content = document.getElementById('content');
    if (!content) return;

    fuzzySearchIndex = { headings: [], text: [] };

    const headings = content.querySelectorAll('h1, h2, h3, h4, h5, h6');
    headings.forEach((heading, index) => {
        const text = heading.textContent.replace(/^\s*?\s*/, '').trim();
        const level = heading.tagName.toLowerCase();
        fuzzySearchIndex.headings.push({
            type: level.toUpperCase(),
            text: text,
            element: heading,
            id: heading.id || `heading-${index}`
        });
    });

    const textElements = content.querySelectorAll('p, li, pre, blockquote, td, th');
    textElements.forEach((el, index) => {
        const text = el.textContent.trim();
        if (text.length > 10 && text.length < 500) {
            let context = '';
            let prevEl = el.previousElementSibling;
            while (prevEl) {
                if (/^H[1-6]$/.test(prevEl.tagName)) {
                    context = prevEl.textContent.replace(/^\s*?\s*/, '').trim();
                    break;
                }
                prevEl = prevEl.previousElementSibling;
            }

            fuzzySearchIndex.text.push({
                type: el.tagName === 'PRE' ? 'CODE' : 'TEXT',
                text: text.slice(0, 200),
                fullText: text,
                element: el,
                context: context
            });
        }
    });
}

function fuzzySearch(query) {
    const index = fuzzySearchMode === 'headings' ? fuzzySearchIndex.headings : fuzzySearchIndex.text;

    if (!query) {
        fuzzyResults = index.slice(0, 50).map(item => ({
            ...item,
            score: 100,
            positions: []
        }));
    } else {
        fuzzyResults = index
            .map(item => {
                const { score, positions } = fuzzyMatch(query, item.text);
                return { ...item, score, positions };
            })
            .filter(item => item.score > 0)
            .sort((a, b) => b.score - a.score)
            .slice(0, 50);
    }

    fuzzySelectedIndex = 0;
    renderFuzzyResults();
}

function renderFuzzyResults() {
    const resultsContainer = document.getElementById('fuzzy-results');
    const countSpan = document.getElementById('fuzzy-result-count');

    if (!fuzzyResults.length) {
        resultsContainer.innerHTML = '<div class="fuzzy-no-results">No results found</div>';
        countSpan.textContent = '0 results';
        return;
    }

    countSpan.textContent = `${fuzzyResults.length} result${fuzzyResults.length !== 1 ? 's' : ''}`;

    resultsContainer.innerHTML = fuzzyResults.map((result, index) => {
        const isSelected = index === fuzzySelectedIndex;
        const highlightedText = highlightMatches(result.text, result.positions);
        const context = result.context ? `<div class="fuzzy-result-context">in: ${escapeHtml(result.context)}</div>` : '';

        return `
            <div class="fuzzy-result-item${isSelected ? ' selected' : ''}" data-index="${index}">
                <div class="fuzzy-result-title">
                    <span class="fuzzy-result-type">${result.type}</span>
                    ${highlightedText}
                </div>
                ${context}
            </div>
        `;
    }).join('');

    const selectedItem = resultsContainer.querySelector('.fuzzy-result-item.selected');
    if (selectedItem) {
        selectedItem.scrollIntoView({ block: 'nearest' });
    }
}

function openFuzzyFinder() {
    buildFuzzyIndex();
    fuzzyFinderOpen = true;
    fuzzySelectedIndex = 0;

    const overlay = document.getElementById('fuzzy-finder');
    const input = document.getElementById('fuzzy-input');

    overlay.classList.add('visible');
    input.value = '';
    input.placeholder = fuzzySearchMode === 'headings' ? 'Search headings...' : 'Search full text...';

    fuzzySearch('');

    setTimeout(() => input.focus(), 50);
}

function closeFuzzyFinder() {
    fuzzyFinderOpen = false;
    const overlay = document.getElementById('fuzzy-finder');
    overlay.classList.remove('visible');
}

function toggleFuzzyMode() {
    fuzzySearchMode = fuzzySearchMode === 'headings' ? 'text' : 'headings';

    const headingsBtn = document.getElementById('fuzzy-mode-headings');
    const textBtn = document.getElementById('fuzzy-mode-text');
    const input = document.getElementById('fuzzy-input');

    headingsBtn.classList.toggle('active', fuzzySearchMode === 'headings');
    textBtn.classList.toggle('active', fuzzySearchMode === 'text');
    input.placeholder = fuzzySearchMode === 'headings' ? 'Search headings...' : 'Search full text...';

    fuzzySearch(input.value);
}

function selectFuzzyResult() {
    if (fuzzyResults.length === 0) return;

    const result = fuzzyResults[fuzzySelectedIndex];
    if (result && result.element) {
        closeFuzzyFinder();

        if (result.id) {
            navigateToHeading(result.id);
        } else {
            result.element.scrollIntoView({ behavior: 'smooth', block: 'center' });

            result.element.style.backgroundColor = '#fff8c5';
            result.element.style.transition = 'background-color 0.3s';
            setTimeout(() => {
                result.element.style.backgroundColor = '';
            }, 1500);
        }
    }
}

function handleFuzzyKeydown(e) {
    if (!fuzzyFinderOpen) return;

    switch (e.key) {
        case 'Escape':
            e.preventDefault();
            closeFuzzyFinder();
            break;

        case 'ArrowDown':
            e.preventDefault();
            if (fuzzySelectedIndex < fuzzyResults.length - 1) {
                fuzzySelectedIndex++;
                renderFuzzyResults();
            }
            break;

        case 'ArrowUp':
            e.preventDefault();
            if (fuzzySelectedIndex > 0) {
                fuzzySelectedIndex--;
                renderFuzzyResults();
            }
            break;

        case 'Enter':
            e.preventDefault();
            selectFuzzyResult();
            break;

        case 'Tab':
            e.preventDefault();
            toggleFuzzyMode();
            break;
    }
}

function initFuzzyFinder() {
    const overlay = document.getElementById('fuzzy-finder');
    const input = document.getElementById('fuzzy-input');
    const resultsContainer = document.getElementById('fuzzy-results');
    const headingsBtn = document.getElementById('fuzzy-mode-headings');
    const textBtn = document.getElementById('fuzzy-mode-text');

    document.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === 'p') {
            e.preventDefault();
            if (fuzzyFinderOpen) {
                closeFuzzyFinder();
            } else {
                openFuzzyFinder();
            }
        }

        if (fuzzyFinderOpen) {
            handleFuzzyKeydown(e);
        }
    });

    overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
            closeFuzzyFinder();
        }
    });

    input.addEventListener('input', (e) => {
        fuzzySearch(e.target.value);
    });

    resultsContainer.addEventListener('click', (e) => {
        const item = e.target.closest('.fuzzy-result-item');
        if (item) {
            fuzzySelectedIndex = parseInt(item.dataset.index);
            selectFuzzyResult();
        }
    });

    headingsBtn.addEventListener('click', () => {
        if (fuzzySearchMode !== 'headings') {
            toggleFuzzyMode();
        }
    });

    textBtn.addEventListener('click', () => {
        if (fuzzySearchMode !== 'text') {
            toggleFuzzyMode();
        }
    });
}

// ============================================================================
// Content Update Handler
// ============================================================================

function handleContentUpdate(message, options = {}) {
    const content = document.getElementById('content');
    content.innerHTML = message.data || message.html;

    // Add spacer at the end for better scrolling
    const spacer = document.createElement('div');
    spacer.style.height = '100px';
    spacer.style.pointerEvents = 'none';
    content.appendChild(spacer);

    codeHighlight();
    renderLatex();
    renderMermaid();
    addHeadingAnchors();
    applyLineNumberMode(lineNumberMode, message.source_lines, message.line_map);

    if (tocVisible) {
        generateTOC();
    }

    scrollToHash();

    if (message.file_path) {
        currentFilePath = message.file_path;
        addToRecentFiles(currentFilePath);
        if (options.onFileClick) {
            renderRecentFiles(options.onFileClick);
        } else {
            renderRecentFiles();
        }
        updateFilePathBar(currentFilePath, message.git_root);
        document.title = getFileBasename(currentFilePath) + ' - Markdown Preview';

        if (options.onFileOpened) {
            options.onFileOpened(currentFilePath);
        }
    }

    if (message.stats) {
        updateDocumentStats(message.stats);
    }

    if (message.should_focus) {
        window.focus();
    }
}

// ============================================================================
// Initialize Core UI
// ============================================================================

function initCoreUI(options = {}) {
    // Restore saved preferences
    const savedMode = localStorage.getItem('lineNumberMode') || 'off';
    lineNumberMode = savedMode;
    document.getElementById('line-numbers-mode').value = savedMode;

    const savedTOCMode = localStorage.getItem('tocMode');
    let tocMode = 'off';
    if (savedTOCMode) {
        tocMode = savedTOCMode;
    } else if (window.innerWidth >= 1440) {
        tocMode = 'right';
    }
    document.getElementById('toc-mode').value = tocMode;

    const savedFont = localStorage.getItem('fontFamily') || 'default';
    fontFamily = savedFont;
    document.getElementById('font-family').value = savedFont;

    const savedReaderMode = localStorage.getItem('readerMode') === 'true';
    readerMode = savedReaderMode;
    document.getElementById('reader-mode').value = savedReaderMode ? 'on' : 'off';

    const savedTheme = localStorage.getItem('theme') || 'auto';
    currentTheme = savedTheme;
    document.getElementById('theme-select').value = savedTheme;

    const savedZoom = parseInt(localStorage.getItem('zoomLevel')) || 100;
    zoomLevel = savedZoom;
    updateZoomDisplay();

    // Set up event listeners
    document.getElementById('line-numbers-mode').addEventListener('change', (e) => {
        changeLineNumberMode(e.target.value);
    });

    document.getElementById('toc-mode').addEventListener('change', (e) => {
        toggleTOC(e.target.value);
    });

    document.getElementById('font-family').addEventListener('change', (e) => {
        changeFontFamily(e.target.value);
    });

    document.getElementById('reader-mode').addEventListener('change', (e) => {
        toggleReaderMode(e.target.value === 'on');
    });

    document.getElementById('theme-select').addEventListener('change', (e) => {
        changeTheme(e.target.value);
    });

    // Zoom controls
    const zoomOutBtn = document.getElementById('zoom-out-btn');
    const zoomInBtn = document.getElementById('zoom-in-btn');
    const zoomResetBtn = document.getElementById('zoom-reset-btn');

    if (zoomOutBtn) zoomOutBtn.addEventListener('click', zoomOut);
    if (zoomInBtn) zoomInBtn.addEventListener('click', zoomIn);
    if (zoomResetBtn) zoomResetBtn.addEventListener('click', resetZoom);

    document.getElementById('file-path-bar').addEventListener('click', () => {
        if (currentFilePath) {
            copyToClipboard(currentFilePath);
        }
    });

    setupTOCResize();

    window.addEventListener('hashchange', () => {
        const hash = window.location.hash.slice(1);
        if (hash) {
            const element = document.getElementById(hash);
            if (element) {
                element.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }
    });

    // Initial rendering
    codeHighlight();
    renderMermaid();
    applyLineNumberMode(lineNumberMode, currentSourceLines, currentLineMap);

    if (tocMode !== 'off') {
        toggleTOC(tocMode);
    }

    changeFontFamily(fontFamily);

    if (readerMode) {
        toggleReaderMode(true);
    }

    changeTheme(currentTheme);

    // Apply saved zoom level
    applyZoom(zoomLevel);

    renderRecentFiles(options.onFileClick);
    initFuzzyFinder();
}

// Export for use in platform-specific modules (browser global scope)
// These are needed because core.js uses 'let' which doesn't add to window
window.MarkdownPreviewCore = {
    // Getters/setters for state
    getCurrentFilePath: () => currentFilePath,
    setCurrentFilePath: (path) => { currentFilePath = path; },
    getZoomLevel: () => zoomLevel,

    // Core functions
    initCoreUI,
    handleContentUpdate,
    codeHighlight,
    renderMermaid,
    renderLatex,
    generateTOC,
    updateFilePathBar,
    updateDocumentStats,
    addHeadingAnchors,
    showToast,
    copyToClipboard,
    getFileBasename,
    renderRecentFiles,
    addToRecentFiles,

    // Zoom functions
    zoomIn,
    zoomOut,
    resetZoom,
    applyZoom
};

// Also expose commonly used functions directly for convenience
window.initCoreUI = initCoreUI;
window.handleContentUpdate = handleContentUpdate;
window.codeHighlight = codeHighlight;
window.renderMermaid = renderMermaid;
window.renderLatex = renderLatex;
window.generateTOC = generateTOC;
window.updateFilePathBar = updateFilePathBar;
window.updateDocumentStats = updateDocumentStats;
window.addHeadingAnchors = addHeadingAnchors;
window.showToast = showToast;
window.copyToClipboard = copyToClipboard;
window.getFileBasename = getFileBasename;
window.renderRecentFiles = renderRecentFiles;
window.addToRecentFiles = addToRecentFiles;
window.zoomIn = zoomIn;
window.zoomOut = zoomOut;
window.resetZoom = resetZoom;
window.applyZoom = applyZoom;


// Markdown Preview - Tauri Mode (Standalone App)
// This module handles Tauri IPC communication for the standalone application

// Note: core.js must be loaded before this file

(function() {
    'use strict';

    // Check if we're running in Tauri
    if (typeof window.__TAURI__ === 'undefined') {
        console.log('Not running in Tauri mode');
        return;
    }

    console.log('Running in Tauri mode');

    const { invoke } = window.__TAURI__.core;
    const { listen } = window.__TAURI__.event;

    // Get dialog API (Tauri 2.x)
    function getDialogOpen() {
        return window.__TAURI__.dialog?.open || window.__TAURI__.plugin?.dialog?.open;
    }

    // Open file dialog and load selected file
    async function openFileDialog() {
        const open = getDialogOpen();
        if (!open) {
            console.error('Dialog API not available');
            return null;
        }

        try {
            const selected = await open({
                multiple: false,
                filters: [{ name: 'Markdown', extensions: ['md', 'markdown', 'mdown', 'mkdn', 'mkd'] }]
            });

            if (selected) {
                return await openFile(selected);
            }
        } catch (e) {
            console.error('Failed to open file dialog:', e);
        }

        return null;
    }

    // Open a file by path
    async function openFile(filePath) {
        try {
            const result = await invoke('open_file', { path: filePath });
            if (result && result.html) {
                handleFileOpened(result);
                return result;
            }
        } catch (e) {
            console.error('Failed to open file:', e);
            showToast('Failed to open file: ' + (e.message || e));
        }
        return null;
    }

    // Check if a string is a URL
    function isUrl(str) {
        return str.startsWith('http://') || str.startsWith('https://');
    }

    // Open a URL
    async function openUrl(url) {
        try {
            showToast('Fetching from URL...');
            const result = await invoke('open_url', { url });
            if (result && result.html) {
                handleUrlOpened(result);
                return result;
            }
        } catch (e) {
            console.error('Failed to open URL:', e);
            showToast('Failed to open URL: ' + (e.message || e));
        }
        return null;
    }

    // Handle URL opened result (similar to handleFileOpened but no file watching)
    function handleUrlOpened(result) {
        const content = document.getElementById('content');
        content.innerHTML = result.html;

        codeHighlight();
        renderMermaid();
        renderLatex();
        addHeadingAnchors();
        generateTOC();

        if (result.file_path) {
            updateFilePathBar(result.file_path, null);
            // Extract filename from URL for title
            try {
                const urlPath = new URL(result.file_path).pathname;
                const fileName = urlPath.split('/').pop() || 'Remote Markdown';
                document.title = fileName + ' - Markdown Preview';
            } catch {
                document.title = 'Remote Markdown - Markdown Preview';
            }
        }

        if (result.stats) {
            updateDocumentStats(result.stats);
        }

        showToast('Loaded from URL');
    }

    // Open a path or URL (auto-detects)
    async function openPathOrUrl(input) {
        if (isUrl(input)) {
            return await openUrl(input);
        } else {
            return await openFile(input);
        }
    }

    // Load recent files from backend and render them
    async function loadRecentFilesFromBackend() {
        try {
            const files = await invoke('get_recent_files');
            // Convert backend format to the format expected by renderRecentFiles
            const recentFiles = files.map(path => ({ path, timestamp: Date.now() }));
            // Store in localStorage so renderRecentFiles can use it
            localStorage.setItem('recentFiles', JSON.stringify(recentFiles));
            renderRecentFiles(switchToFile);
        } catch (e) {
            console.error('Failed to load recent files from backend:', e);
        }
    }

    // Handle file opened result
    function handleFileOpened(result) {
        const content = document.getElementById('content');
        content.innerHTML = result.html;

        codeHighlight();
        renderMermaid();
        renderLatex();
        addHeadingAnchors();
        generateTOC();

        if (result.file_path) {
            // Update currentFilePath via the core module's setter
            window.MarkdownPreviewCore.setCurrentFilePath(result.file_path);
            updateFilePathBar(result.file_path, result.git_root);
            document.title = getFileBasename(result.file_path) + ' - Markdown Preview';

            // Refresh recent files from backend (backend already added the file)
            loadRecentFilesFromBackend();

            // Start watching the file for changes
            invoke('watch_file', { path: result.file_path }).catch(e => {
                console.error('Failed to watch file:', e);
            });
        }

        if (result.stats) {
            updateDocumentStats(result.stats);
        }
    }

    // Switch to a different file
    async function switchToFile(filePath) {
        const current = window.MarkdownPreviewCore.getCurrentFilePath();
        if (filePath === current) {
            return;
        }

        await openFile(filePath);
        console.log(`Switched to: ${filePath}`);
    }

    // Set up Tauri event listeners
    function setupTauriListeners() {
        // Listen for file-changed events from Rust (file watcher)
        listen('file-changed', (event) => {
            console.log('File changed:', event.payload);
            handleFileOpened(event.payload);
        });

        // Listen for menu events
        listen('menu-open', async () => {
            await openFileDialog();
        });

        listen('menu-reload', async () => {
            const current = window.MarkdownPreviewCore.getCurrentFilePath();
            if (current) {
                await openFile(current);
            }
        });

        listen('menu-toggle-toc', () => {
            const tocModeSelect = document.getElementById('toc-mode');
            if (tocModeSelect) {
                const current = tocModeSelect.value;
                tocModeSelect.value = current === 'off' ? 'right' : 'off';
                tocModeSelect.dispatchEvent(new Event('change'));
            }
        });

        listen('menu-theme', (event) => {
            const themeSelect = document.getElementById('theme-select');
            if (themeSelect) {
                const themeMap = { 'light': 'github-light', 'dark': 'github-dark', 'auto': 'auto' };
                themeSelect.value = themeMap[event.payload] || event.payload;
                themeSelect.dispatchEvent(new Event('change'));
            }
        });

        // Listen for initial file from command line argument
        listen('open-initial-file', async (event) => {
            console.log('Opening initial file:', event.payload);
            await openFile(event.payload);
        });
    }

    // Set up drag and drop
    function setupDragAndDrop() {
        document.addEventListener('drop', async (e) => {
            e.preventDefault();
            const files = e.dataTransfer?.files;
            if (files && files.length > 0) {
                const file = files[0];
                if (file.name.match(/\.(md|markdown|mdown|mkdn|mkd)$/i)) {
                    const path = file.path || file.name;
                    await openFile(path);
                }
            }
        });

        document.addEventListener('dragover', (e) => {
            e.preventDefault();
        });
    }

    // Set up welcome screen
    function setupWelcomeScreen() {
        const welcomeOpenBtn = document.getElementById('welcome-open-btn');
        if (welcomeOpenBtn) {
            welcomeOpenBtn.addEventListener('click', async () => {
                console.log('Open File button clicked');
                await openFileDialog();
            });
        }
    }

    // Set up keyboard shortcuts
    function setupKeyboardShortcuts() {
        document.addEventListener('keydown', async (e) => {
            // Cmd+O / Ctrl+O to open file by path (with autocomplete)
            if ((e.ctrlKey || e.metaKey) && !e.shiftKey && e.key === 'o') {
                e.preventDefault();
                openPathInput();
            }

            // Cmd+Shift+O / Ctrl+Shift+O to open file dialog
            if ((e.ctrlKey || e.metaKey) && e.shiftKey && (e.key === 'O' || e.key === 'o')) {
                e.preventDefault();
                await openFileDialog();
            }

            // F5 or Cmd+R / Ctrl+R to refresh
            if (e.key === 'F5' || ((e.ctrlKey || e.metaKey) && e.key === 'r')) {
                e.preventDefault();
                const current = window.MarkdownPreviewCore.getCurrentFilePath();
                if (current) {
                    await openFile(current);
                    showToast('Refreshed');
                }
            }

            // Escape to close path input
            if (e.key === 'Escape' && pathInputVisible) {
                closePathInput();
            }

            // Cmd+Q / Ctrl+Q to quit the app
            if ((e.ctrlKey || e.metaKey) && e.key === 'q') {
                e.preventDefault();
                const { getCurrentWindow } = window.__TAURI__.window;
                getCurrentWindow().close();
            }

            // Cmd+C / Ctrl+C to copy selected text
            if ((e.ctrlKey || e.metaKey) && e.key === 'c') {
                const selection = window.getSelection();
                const selectedText = selection ? selection.toString() : '';
                if (selectedText) {
                    e.preventDefault();
                    try {
                        const clipboardApi = window.__TAURI__.clipboard
                            || window.__TAURI__.clipboardManager
                            || window.__TAURI__.plugin?.clipboardManager;
                        if (clipboardApi && clipboardApi.writeText) {
                            await clipboardApi.writeText(selectedText);
                        }
                    } catch (err) {
                        console.error('Failed to copy:', err);
                    }
                }
            }
        });
    }

    // Path input state
    let pathInputVisible = false;
    let autocompleteState = {
        items: [],
        selectedIndex: -1,
        debounceTimer: null
    };

    // Fetch path completions from backend
    async function fetchCompletions(partial) {
        try {
            return await invoke('complete_path', { partial });
        } catch (e) {
            console.error('Failed to fetch completions:', e);
            return [];
        }
    }

    // Render autocomplete dropdown
    function renderAutocomplete(items) {
        const dropdown = document.getElementById('path-autocomplete');
        if (!dropdown) return;

        autocompleteState.items = items;
        autocompleteState.selectedIndex = items.length > 0 ? 0 : -1;

        if (items.length === 0) {
            dropdown.style.display = 'none';
            return;
        }

        dropdown.innerHTML = items.map((item, index) => `
            <div class="autocomplete-item ${index === 0 ? 'selected' : ''}" data-index="${index}">
                <span class="autocomplete-icon">${item.is_dir ? '' : ''}</span>
                <span class="autocomplete-name">${item.name}</span>
            </div>
        `).join('');

        dropdown.style.display = 'block';

        // Add click handlers
        dropdown.querySelectorAll('.autocomplete-item').forEach(el => {
            el.addEventListener('click', () => {
                const index = parseInt(el.dataset.index);
                selectAutocompleteItem(index);
            });
        });
    }

    // Select an autocomplete item
    function selectAutocompleteItem(index) {
        const item = autocompleteState.items[index];
        if (!item) return;

        const input = document.getElementById('path-input-field');
        input.value = item.path;
        input.focus();

        // If it's a directory, trigger another completion
        if (item.is_dir) {
            triggerAutocomplete(item.path);
        } else {
            // Hide dropdown for files
            const dropdown = document.getElementById('path-autocomplete');
            if (dropdown) dropdown.style.display = 'none';
        }
    }

    // Update selection highlight
    function updateAutocompleteSelection() {
        const dropdown = document.getElementById('path-autocomplete');
        if (!dropdown) return;

        dropdown.querySelectorAll('.autocomplete-item').forEach((el, index) => {
            el.classList.toggle('selected', index === autocompleteState.selectedIndex);
        });

        // Scroll selected item into view
        const selected = dropdown.querySelector('.autocomplete-item.selected');
        if (selected) {
            selected.scrollIntoView({ block: 'nearest' });
        }
    }

    // Trigger autocomplete with debouncing
    function triggerAutocomplete(value) {
        if (autocompleteState.debounceTimer) {
            clearTimeout(autocompleteState.debounceTimer);
        }

        autocompleteState.debounceTimer = setTimeout(async () => {
            if (value.length > 0) {
                const items = await fetchCompletions(value);
                renderAutocomplete(items);
            } else {
                const dropdown = document.getElementById('path-autocomplete');
                if (dropdown) dropdown.style.display = 'none';
            }
        }, 100);
    }

    // Open path input modal
    function openPathInput() {
        if (pathInputVisible) return;
        pathInputVisible = true;

        // Create modal if it doesn't exist
        let modal = document.getElementById('path-input-modal');
        if (!modal) {
            modal = document.createElement('div');
            modal.id = 'path-input-modal';
            modal.className = 'path-input-overlay';
            modal.innerHTML = `
                <div class="path-input-container">
                    <div class="path-input-header">
                        <label>Open file or URL</label>
                        <span class="path-input-hint">Type path to autocomplete, or paste a GitHub URL</span>
                    </div>
                    <div class="path-input-wrapper">
                        <input type="text" id="path-input-field" class="path-input-field"
                               placeholder="/path/to/file.md or https://github.com/..." autocomplete="off" spellcheck="false">
                        <div id="path-autocomplete" class="path-autocomplete"></div>
                    </div>
                    <div class="path-input-footer">
                        <span class="key"></span> navigate
                        <span class="key">Tab</span> complete
                        <span class="key">Enter</span> open
                        <span class="key">Esc</span> cancel
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // Add styles
            const style = document.createElement('style');
            style.textContent = `
                .path-input-overlay {
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0, 0, 0, 0.5);
                    display: flex;
                    align-items: flex-start;
                    justify-content: center;
                    padding-top: 15vh;
                    z-index: 10000;
                    opacity: 0;
                    visibility: hidden;
                    transition: opacity 0.15s, visibility 0.15s;
                }
                .path-input-overlay.visible {
                    opacity: 1;
                    visibility: visible;
                }
                .path-input-container {
                    background: #fff;
                    border-radius: 8px;
                    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
                    width: 600px;
                    max-width: 90vw;
                    overflow: hidden;
                }
                .path-input-header {
                    padding: 12px 16px;
                    border-bottom: 1px solid #e1e4e8;
                }
                .path-input-header label {
                    font-weight: 600;
                    font-size: 14px;
                }
                .path-input-hint {
                    display: block;
                    font-size: 12px;
                    color: #666;
                    margin-top: 4px;
                }
                .path-input-wrapper {
                    position: relative;
                }
                .path-input-field {
                    width: 100%;
                    padding: 12px 16px;
                    border: none;
                    font-size: 14px;
                    font-family: ui-monospace, SFMono-Regular, "SF Mono", Menlo, monospace;
                    outline: none;
                    box-sizing: border-box;
                }
                .path-autocomplete {
                    display: none;
                    max-height: 240px;
                    overflow-y: auto;
                    border-top: 1px solid #e1e4e8;
                }
                .autocomplete-item {
                    padding: 8px 16px;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    font-family: ui-monospace, SFMono-Regular, "SF Mono", Menlo, monospace;
                    font-size: 13px;
                }
                .autocomplete-item:hover,
                .autocomplete-item.selected {
                    background: #f0f6ff;
                }
                .autocomplete-icon {
                    font-size: 14px;
                    width: 20px;
                    text-align: center;
                }
                .autocomplete-name {
                    overflow: hidden;
                    text-overflow: ellipsis;
                    white-space: nowrap;
                }
                .path-input-footer {
                    padding: 8px 16px;
                    background: #f6f8fa;
                    font-size: 12px;
                    color: #666;
                }
                .path-input-footer .key {
                    background: #e1e4e8;
                    padding: 2px 6px;
                    border-radius: 3px;
                    font-family: ui-monospace, SFMono-Regular, monospace;
                    margin-right: 4px;
                }
                @media (prefers-color-scheme: dark) {
                    .path-input-container { background: #1c1c1e; }
                    .path-input-header { border-color: #3a3a3c; }
                    .path-input-header label { color: #fff; }
                    .path-input-hint { color: #98989f; }
                    .path-input-field { background: #1c1c1e; color: #fff; }
                    .path-autocomplete { border-color: #3a3a3c; }
                    .autocomplete-item { color: #fff; }
                    .autocomplete-item:hover,
                    .autocomplete-item.selected { background: #2c3e50; }
                    .path-input-footer { background: #2c2c2e; }
                    .path-input-footer .key { background: #3a3a3c; color: #fff; }
                }
                body.theme-github-dark .path-input-container,
                body.theme-dark .path-input-container,
                body.theme-material-dark .path-input-container,
                body.theme-one-dark .path-input-container {
                    background: #1c1c1e;
                }
                body.theme-github-dark .path-input-header,
                body.theme-dark .path-input-header,
                body.theme-material-dark .path-input-header,
                body.theme-one-dark .path-input-header {
                    border-color: #3a3a3c;
                }
                body.theme-github-dark .path-input-header label,
                body.theme-dark .path-input-header label,
                body.theme-material-dark .path-input-header label,
                body.theme-one-dark .path-input-header label {
                    color: #fff;
                }
                body.theme-github-dark .path-input-field,
                body.theme-dark .path-input-field,
                body.theme-material-dark .path-input-field,
                body.theme-one-dark .path-input-field {
                    background: #1c1c1e;
                    color: #fff;
                }
                body.theme-github-dark .path-autocomplete,
                body.theme-dark .path-autocomplete,
                body.theme-material-dark .path-autocomplete,
                body.theme-one-dark .path-autocomplete {
                    border-color: #3a3a3c;
                }
                body.theme-github-dark .autocomplete-item,
                body.theme-dark .autocomplete-item,
                body.theme-material-dark .autocomplete-item,
                body.theme-one-dark .autocomplete-item {
                    color: #fff;
                }
                body.theme-github-dark .autocomplete-item:hover,
                body.theme-github-dark .autocomplete-item.selected,
                body.theme-dark .autocomplete-item:hover,
                body.theme-dark .autocomplete-item.selected,
                body.theme-material-dark .autocomplete-item:hover,
                body.theme-material-dark .autocomplete-item.selected,
                body.theme-one-dark .autocomplete-item:hover,
                body.theme-one-dark .autocomplete-item.selected {
                    background: #2c3e50;
                }
                body.theme-github-dark .path-input-footer,
                body.theme-dark .path-input-footer,
                body.theme-material-dark .path-input-footer,
                body.theme-one-dark .path-input-footer {
                    background: #2c2c2e;
                }
            `;
            document.head.appendChild(style);

            // Click outside to close
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closePathInput();
                }
            });

            // Handle input events
            const input = document.getElementById('path-input-field');

            // Input change - trigger autocomplete
            input.addEventListener('input', (e) => {
                triggerAutocomplete(e.target.value);
            });

            // Keyboard navigation
            input.addEventListener('keydown', async (e) => {
                const dropdown = document.getElementById('path-autocomplete');
                const isDropdownVisible = dropdown && dropdown.style.display !== 'none';

                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    if (isDropdownVisible && autocompleteState.items.length > 0) {
                        autocompleteState.selectedIndex = Math.min(
                            autocompleteState.selectedIndex + 1,
                            autocompleteState.items.length - 1
                        );
                        updateAutocompleteSelection();
                    }
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    if (isDropdownVisible && autocompleteState.items.length > 0) {
                        autocompleteState.selectedIndex = Math.max(
                            autocompleteState.selectedIndex - 1,
                            0
                        );
                        updateAutocompleteSelection();
                    }
                } else if (e.key === 'Tab') {
                    e.preventDefault();
                    if (isDropdownVisible && autocompleteState.selectedIndex >= 0) {
                        selectAutocompleteItem(autocompleteState.selectedIndex);
                    }
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    // If dropdown visible and item selected, use that item
                    if (isDropdownVisible && autocompleteState.selectedIndex >= 0) {
                        const item = autocompleteState.items[autocompleteState.selectedIndex];
                        if (item && !item.is_dir) {
                            closePathInput();
                            await openFile(item.path);
                            return;
                        } else if (item && item.is_dir) {
                            selectAutocompleteItem(autocompleteState.selectedIndex);
                            return;
                        }
                    }
                    // Otherwise use the input value (could be path or URL)
                    const inputValue = input.value.trim();
                    if (inputValue) {
                        closePathInput();
                        await openPathOrUrl(inputValue);
                    }
                } else if (e.key === 'Escape') {
                    if (isDropdownVisible) {
                        dropdown.style.display = 'none';
                    } else {
                        closePathInput();
                    }
                } else if ((e.ctrlKey || e.metaKey) && e.key === 'v') {
                    // Handle paste using Tauri clipboard API
                    e.preventDefault();
                    try {
                        const clipboardApi = window.__TAURI__.clipboard
                            || window.__TAURI__.clipboardManager
                            || window.__TAURI__.plugin?.clipboardManager;
                        if (clipboardApi && clipboardApi.readText) {
                            const text = await clipboardApi.readText();
                            if (text) {
                                const start = input.selectionStart;
                                const end = input.selectionEnd;
                                const before = input.value.substring(0, start);
                                const after = input.value.substring(end);
                                input.value = before + text + after;
                                input.selectionStart = input.selectionEnd = start + text.length;
                                triggerAutocomplete(input.value);
                            }
                        }
                    } catch (err) {
                        console.error('Failed to paste:', err);
                    }
                }
            });
        }

        modal.classList.add('visible');
        const input = document.getElementById('path-input-field');
        input.value = '';
        autocompleteState.items = [];
        autocompleteState.selectedIndex = -1;
        const dropdown = document.getElementById('path-autocomplete');
        if (dropdown) dropdown.style.display = 'none';
        setTimeout(() => input.focus(), 50);
    }

    // Close path input modal
    function closePathInput() {
        pathInputVisible = false;
        const modal = document.getElementById('path-input-modal');
        if (modal) {
            modal.classList.remove('visible');
        }
        // Clear autocomplete state
        autocompleteState.items = [];
        autocompleteState.selectedIndex = -1;
        if (autocompleteState.debounceTimer) {
            clearTimeout(autocompleteState.debounceTimer);
        }
    }

    // Check clipboard for markdown file path (optional feature)
    async function checkClipboardForMarkdown() {
        try {
            const clipboardPath = await invoke('check_clipboard_for_markdown');
            if (clipboardPath) {
                console.log('Found markdown file in clipboard:', clipboardPath);
                return clipboardPath;
            }
        } catch (e) {
            console.error('Failed to check clipboard:', e);
        }
        return null;
    }

    // Set up clipboard monitoring on window focus
    function setupClipboardMonitoring() {
        let lastClipboardPath = null;

        async function checkClipboard() {
            const current = window.MarkdownPreviewCore.getCurrentFilePath();
            // Only check if no file is currently open
            if (current) {
                return;
            }

            const clipboardPath = await checkClipboardForMarkdown();
            if (clipboardPath && clipboardPath !== lastClipboardPath) {
                lastClipboardPath = clipboardPath;
                await openFile(clipboardPath);
            }
        }

        // Use Tauri's window focus event
        if (window.__TAURI__.window) {
            const { getCurrentWindow } = window.__TAURI__.window;
            const currentWindow = getCurrentWindow();
            currentWindow.onFocusChanged(({ payload: focused }) => {
                if (focused) {
                    checkClipboard();
                }
            });
        }
    }

    // Initialize on DOM ready
    document.addEventListener('DOMContentLoaded', async function() {
        // Initialize core UI with file switch callback
        initCoreUI({
            onFileClick: switchToFile
        });

        // Load recent files from backend (persistent storage)
        await loadRecentFilesFromBackend();

        // Set up Tauri-specific features
        setupTauriListeners();
        setupDragAndDrop();
        setupWelcomeScreen();
        setupKeyboardShortcuts();
        setupClipboardMonitoring();
    });
})();

    </script>

    <div id="toast" class="toast">
        <div class="toast-title">Copied!</div>
        <div class="toast-path"></div>
    </div>

    <!-- Fuzzy Finder Modal -->
    <div id="fuzzy-finder" class="fuzzy-finder-overlay">
        <div class="fuzzy-finder-container">
            <div class="fuzzy-finder-header">
                <div class="fuzzy-finder-input-wrapper">
                    <svg class="fuzzy-finder-icon" viewBox="0 0 16 16" width="16" height="16">
                        <path fill-rule="evenodd" d="M11.5 7a4.5 4.5 0 11-9 0 4.5 4.5 0 019 0zm-.82 4.74a6 6 0 111.06-1.06l3.04 3.04a.75.75 0 11-1.06 1.06l-3.04-3.04z"></path>
                    </svg>
                    <input type="text" id="fuzzy-input" class="fuzzy-finder-input" placeholder="Search headings..." autocomplete="off" spellcheck="false">
                    <div class="fuzzy-finder-mode-toggle">
                        <button id="fuzzy-mode-headings" class="fuzzy-mode-btn active" title="Search headings only">H</button>
                        <button id="fuzzy-mode-text" class="fuzzy-mode-btn" title="Search full text">T</button>
                    </div>
                </div>
                <div class="fuzzy-finder-hint">
                    <span class="key"></span> navigate
                    <span class="key">Enter</span> jump
                    <span class="key">Esc</span> close
                    <span class="key">Tab</span> toggle mode
                </div>
            </div>
            <div id="fuzzy-results" class="fuzzy-finder-results"></div>
            <div class="fuzzy-finder-footer">
                <span id="fuzzy-result-count">0 results</span>
            </div>
        </div>
    </div>
</body>
</html>
